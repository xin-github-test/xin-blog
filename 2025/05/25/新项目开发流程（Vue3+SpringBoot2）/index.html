<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>新项目开发流程 | xin-blog</title><meta name="author" content="xin"><meta name="copyright" content="xin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="新项目开发流程新建项目选择项目类型（boot，cloud）———》jdk 版本 ——–》boot、cloud 版本 导入依赖-pom.xml通用依赖：mvc、mybatis&#x2F;mybatis-plus、hutool、mysql、接口文档、aop 编程等 123456789101112131415161718192021222324252627282930313233343536373839">
<meta property="og:type" content="article">
<meta property="og:title" content="新项目开发流程">
<meta property="og:url" content="https://blog.xintest.dpdns.org/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/index.html">
<meta property="og:site_name" content="xin-blog">
<meta property="og:description" content="新项目开发流程新建项目选择项目类型（boot，cloud）———》jdk 版本 ——–》boot、cloud 版本 导入依赖-pom.xml通用依赖：mvc、mybatis&#x2F;mybatis-plus、hutool、mysql、接口文档、aop 编程等 123456789101112131415161718192021222324252627282930313233343536373839">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.xintest.dpdns.org/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-05-25T14:55:07.556Z">
<meta property="article:modified_time" content="2025-05-25T15:14:29.232Z">
<meta property="article:author" content="xin">
<meta property="article:tag" content="encrypt">
<meta property="article:tag" content="开发流程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.xintest.dpdns.org/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "新项目开发流程",
  "url": "https://blog.xintest.dpdns.org/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/",
  "image": "https://blog.xintest.dpdns.org/img/butterfly-icon.png",
  "datePublished": "2025-05-25T14:55:07.556Z",
  "dateModified": "2025-05-25T15:14:29.232Z",
  "author": [
    {
      "@type": "Person",
      "name": "xin",
      "url": "https://blog.xintest.dpdns.org"
    }
  ]
}</script><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://blog.xintest.dpdns.org/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '新项目开发流程',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">xin-blog</span></a><a class="nav-page-title" href="/"><span class="site-name">新项目开发流程</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">新项目开发流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-05-25T14:55:07.556Z" title="Created 2025-05-25 22:55:07">2025-05-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-05-25T15:14:29.232Z" title="Updated 2025-05-25 23:14:29">2025-05-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/note/">note</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="新项目开发流程"><a href="#新项目开发流程" class="headerlink" title="新项目开发流程"></a>新项目开发流程</h1><h2 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h2><p>选择项目类型（boot，cloud）———》jdk 版本 ——–》boot、cloud 版本</p>
<h2 id="导入依赖-pom-xml"><a href="#导入依赖-pom-xml" class="headerlink" title="导入依赖-pom.xml"></a>导入依赖-pom.xml</h2><p>通用依赖：mvc、mybatis&#x2F;mybatis-plus、hutool、mysql、接口文档、aop 编程等</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xin-picture-backend<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>xin-picture-backend<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>xin-picture-backend<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.7.6<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--        切面编程--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--数据库操作：https://baomidou.com/getting-started/--&gt;</span><br><span class="hljs-comment">&lt;!--        注意：3.5.9及之后版本：1）移除了分页插件，若要使用分页，需要额外引入；2）无需引入mybatis的starter，否则会不兼容--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.10.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--工具类：https://www.hutool.cn/--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--接口文档：https://doc.xiaominfo.com/docs/quick-start--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-openapi2-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.xin.xinpicturebackend.XinPictureBackendApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">skip</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skip</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<h2 id="配置文件-application-yml"><a href="#配置文件-application-yml" class="headerlink" title="配置文件-application.yml"></a>配置文件-application.yml</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/api</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">xin-picture-backend</span><br>  <span class="hljs-comment"># 数据库配置</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/xin_picture</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-comment"># MyBatis 配置</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># 仅在开发环境，显示执行的sql语句</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">isDeleted</span> <span class="hljs-comment"># 全局逻辑删除字段名</span><br>      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 逻辑已删除值</span><br>      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 逻辑未删除值</span><br><span class="hljs-comment">#接口文档配置</span><br><span class="hljs-attr">knife4j:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">openapi:</span><br>    <span class="hljs-attr">title:</span> <span class="hljs-string">xin-picture接口文档</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0</span><br>    <span class="hljs-attr">group:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">api-rule:</span> <span class="hljs-string">package</span><br>        <span class="hljs-attr">api-rule-resources:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">com.xin.xinpicturebackend.controller</span><br></code></pre></td></tr></table></figure>

<h2 id="启动类添加注解"><a href="#启动类添加注解" class="headerlink" title="启动类添加注解"></a>启动类添加注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.xin.xinpicturebackend.mapper&quot;)</span><br><span class="hljs-comment">//将aop代理暴露出来，从而能够在开发中获取（AopContext.currentProxy()）</span><br><span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XinPictureBackendApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(XinPictureBackendApplication.class, args);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="通用类编写"><a href="#通用类编写" class="headerlink" title="通用类编写"></a>通用类编写</h2><p><img src="/staticImg/image-20250310225200543.png" alt="image-20250310225200543"></p>
<h3 id="1-异常包-exception"><a href="#1-异常包-exception" class="headerlink" title="1.异常包-exception"></a>1.异常包-exception</h3><p>:star: ErrorCode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.exception;<br><br><span class="hljs-keyword">import</span> lombok.Getter;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> &#123;<br><br>    SUCCESS(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;ok&quot;</span>),<br>    PARAMS_ERROR(<span class="hljs-number">40000</span>, <span class="hljs-string">&quot;请求参数错误&quot;</span>),<br>    NOT_LOGIN_ERROR(<span class="hljs-number">40100</span>, <span class="hljs-string">&quot;未登录&quot;</span>),<br>    NO_AUTH_ERROR(<span class="hljs-number">40101</span>, <span class="hljs-string">&quot;无权限&quot;</span>),<br>    NOT_FOUND_ERROR(<span class="hljs-number">40400</span>, <span class="hljs-string">&quot;请求数据不存在&quot;</span>),<br>    FORBIDDEN_ERROR(<span class="hljs-number">40300</span>, <span class="hljs-string">&quot;禁止访问&quot;</span>),<br>    SYSTEM_ERROR(<span class="hljs-number">50000</span>, <span class="hljs-string">&quot;系统内部异常&quot;</span>),<br>    OPERATION_ERROR(<span class="hljs-number">50001</span>, <span class="hljs-string">&quot;操作失败&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;<br><br>    ErrorCode(<span class="hljs-type">int</span> code, String message) &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.message = message;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:BusinessException</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.exception;<br><br><span class="hljs-keyword">import</span> lombok.Getter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义业务异常</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 错误码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span> <span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> &#123;<br>        <span class="hljs-built_in">super</span>(message);<br>        <span class="hljs-built_in">this</span>.code = code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span> <span class="hljs-params">(ErrorCode errorCode)</span> &#123;<br>        <span class="hljs-built_in">super</span>(errorCode.getMessage());<br>        <span class="hljs-built_in">this</span>.code = errorCode.getCode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span> <span class="hljs-params">(ErrorCode errorCode, String message)</span> &#123;<br>        <span class="hljs-built_in">super</span>(message);<br>        <span class="hljs-built_in">this</span>.code = errorCode.getCode();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:ThrowUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.exception;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 异常处理工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThrowUtils</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件成立则抛异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> condition         条件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> runtimeException  异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">throwIf</span><span class="hljs-params">(<span class="hljs-type">boolean</span> condition, RuntimeException runtimeException)</span> &#123;<br>        <span class="hljs-keyword">if</span> (condition) &#123;<br>            <span class="hljs-keyword">throw</span> runtimeException;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件成立抛异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> condition 条件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> errorCode 错误码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">throwIf</span><span class="hljs-params">(<span class="hljs-type">boolean</span> condition, ErrorCode errorCode)</span> &#123;<br>        throwIf(condition, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(errorCode));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件成立抛异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> condition 条件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> errorCode 错误码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 错误信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">throwIf</span><span class="hljs-params">(<span class="hljs-type">boolean</span> condition, ErrorCode errorCode, String message)</span> &#123;<br>        throwIf(condition, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(errorCode,message));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="2-通用包-common"><a href="#2-通用包-common" class="headerlink" title="2.通用包-common"></a>2.通用包-common</h3><p>:star:BaseResponse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.common;<br><br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.ErrorCode;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 全局响应封装</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseResponse</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br>    <span class="hljs-keyword">private</span> T data;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> code, T data, String message)</span> &#123;<br>        <span class="hljs-built_in">this</span>.code = code;<br>        <span class="hljs-built_in">this</span>.data = data;<br>        <span class="hljs-built_in">this</span>.message = message;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> code, T data)</span> &#123;<br>        <span class="hljs-built_in">this</span>(code, data, <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseResponse</span><span class="hljs-params">(ErrorCode errorCode)</span> &#123;<br>        <span class="hljs-built_in">this</span>(errorCode.getCode(), <span class="hljs-literal">null</span>, errorCode.getMessage());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:ResultUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.common;<br><br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.ErrorCode;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultUtils</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 成功</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data 数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;  数据类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 响应</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; BaseResponse&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>&lt;&gt;(<span class="hljs-number">0</span>, data, <span class="hljs-string">&quot;ok&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 失败</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> errorCode 错误码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 响应</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BaseResponse&lt;?&gt; error(ErrorCode errorCode) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>&lt;&gt;(errorCode);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 失败</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> code    错误码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 错误信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 响应</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BaseResponse&lt;?&gt; error(<span class="hljs-type">int</span> code, String message) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>&lt;&gt;(code, <span class="hljs-literal">null</span>, message);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 失败</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> errorCode 错误码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 响应</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BaseResponse&lt;?&gt; error(ErrorCode errorCode, String message) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>&lt;&gt;(errorCode.getCode(), <span class="hljs-literal">null</span>, message);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>:star:PageRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.common;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageRequest</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前页号</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 页面大小</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 排序字段</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String sortField;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 排序顺序</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">sortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;descend&quot;</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:DeleteRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.common;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通用的删除请求类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeleteRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="前后端分离项目-跨域问题处理"><a href="#前后端分离项目-跨域问题处理" class="headerlink" title="前后端分离项目-跨域问题处理"></a>前后端分离项目-跨域问题处理</h2><p>跨域问题只出现在<strong>浏览器</strong>（同源策略）</p>
<h3 id="解决方式："><a href="#解决方式：" class="headerlink" title="解决方式："></a>解决方式：</h3><h4 id="1）后端处理，支持跨域"><a href="#1）后端处理，支持跨域" class="headerlink" title="1）后端处理，支持跨域"></a>1）后端处理，支持跨域</h4><p>局部解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">@CrossOrigin()注解，在需要解决跨域的controller上直接使用即可<br></code></pre></td></tr></table></figure>

<p>全局配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span><span class="hljs-params">(CorsRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 覆盖所有请求</span><br>        registry.addMapping(<span class="hljs-string">&quot;/**&quot;</span>)<br>                <span class="hljs-comment">// 允许发送 Cookie</span><br>                .allowCredentials(<span class="hljs-literal">true</span>)<br>                <span class="hljs-comment">// 放行哪些域名（必须用 patterns，否则 * 会和 allowCredentials 冲突）</span><br>                .allowedOriginPatterns(<span class="hljs-string">&quot;*&quot;</span>)<br>                .allowedMethods(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;PUT&quot;</span>, <span class="hljs-string">&quot;DELETE&quot;</span>, <span class="hljs-string">&quot;OPTIONS&quot;</span>)<br>                .allowedHeaders(<span class="hljs-string">&quot;*&quot;</span>)<br>                .exposedHeaders(<span class="hljs-string">&quot;*&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2）后端不处理-代理（nginx）"><a href="#2）后端不处理-代理（nginx）" class="headerlink" title="2）后端不处理-代理（nginx）"></a>2）后端不处理-代理（nginx）</h4><p>通过<strong>ngin</strong>将请求进行转发</p>
<h2 id="运行后端项目-健康检查测试"><a href="#运行后端项目-健康检查测试" class="headerlink" title="运行后端项目-健康检查测试"></a>运行后端项目-健康检查测试</h2><p>:star:在 controller 包下创建如下类，然后启动项目，尝试访问！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.controller;<br><br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.common.BaseResponse;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.common.ResultUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainController</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 健康检查</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/health&quot;)</span><br>    <span class="hljs-keyword">public</span> BaseResponse&lt;String&gt; <span class="hljs-title function_">health</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> ResultUtils.success(<span class="hljs-string">&quot;ok&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="前端初始化-Vue"><a href="#前端初始化-Vue" class="headerlink" title="前端初始化-Vue"></a>前端初始化-Vue</h2><h3 id="1-安装-nodeJs"><a href="#1-安装-nodeJs" class="headerlink" title="1.安装 nodeJs"></a>1.安装 nodeJs</h3><h3 id="2-初始化-Vue-项目"><a href="#2-初始化-Vue-项目" class="headerlink" title="2.初始化 Vue 项目"></a>2.初始化 Vue 项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm create vue@latest<br></code></pre></td></tr></table></figure>

<ul>
<li>输入项目名称</li>
<li>TS 语法：是</li>
<li>启用 JSX 支持：否</li>
<li>引用 Vue Router：是</li>
<li>引入 Pinia ：是</li>
<li>引入 Vitest 单元测试：否</li>
<li>引用 端到端 测试工具：否</li>
<li>引用 EsLint 用于代码质量检查：是</li>
<li>引入 Oxlint 加快检测：否</li>
<li>引入 Prettier 用于代码格式化：是</li>
</ul>
<h3 id="3-安装依赖"><a href="#3-安装依赖" class="headerlink" title="3.安装依赖"></a>3.安装依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install -y<br></code></pre></td></tr></table></figure>

<h3 id="4-安装组件库-antd-vue"><a href="#4-安装组件库-antd-vue" class="headerlink" title="4.安装组件库-antd-vue"></a>4.安装组件库-antd-vue</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm i --save ant-design-vue@4.x<br></code></pre></td></tr></table></figure>

<h3 id="5-注册组件库"><a href="#5-注册组件库" class="headerlink" title="5.注册组件库"></a>5.注册组件库</h3><p>:star:全局注册</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Antd</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;ant-design-vue&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./App&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;ant-design-vue/dist/reset.css&quot;</span>;<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Antd</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#app&quot;</span>);<br></code></pre></td></tr></table></figure>

<h3 id="6-安装异步请求工具-axios"><a href="#6-安装异步请求工具-axios" class="headerlink" title="6.安装异步请求工具-axios"></a>6.安装异步请求工具-axios</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install axios<br></code></pre></td></tr></table></figure>

<h3 id="7-安装接口生成工具-umijs-openapi"><a href="#7-安装接口生成工具-umijs-openapi" class="headerlink" title="7.安装接口生成工具-umijs&#x2F;openapi"></a>7.安装接口生成工具-umijs&#x2F;openapi</h3><p>:star:配合后端 knife4j 接口文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm i --save-dev @umijs/openapi<br></code></pre></td></tr></table></figure>

<p>:star:配置编写</p>
<p>项目根路径下新建文件：<code>openapi.config.js</code>，内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; generateService &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@umijs/openapi&quot;</span>;<br><br><span class="hljs-title function_">generateService</span>(&#123;<br>  <span class="hljs-attr">requestLibPath</span>: <span class="hljs-string">&quot;import request from `@/request`&quot;</span>, <span class="hljs-comment">//生成的文件都要引入的包</span><br>  <span class="hljs-attr">schemaPath</span>: <span class="hljs-string">&quot;http://localhost:8080/api/v2/api-docs&quot;</span>, <span class="hljs-comment">//后端接口文档地址</span><br>  <span class="hljs-attr">serversPath</span>: <span class="hljs-string">&quot;./src&quot;</span>, <span class="hljs-comment">//文件生成路径</span><br>&#125;);<br></code></pre></td></tr></table></figure>

<p>:star:配置生成脚本</p>
<p>在<code>package.json</code>文件的<code>scrpts</code>中添加下面一行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;openapi&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node openapi.config.js&quot;</span><br></code></pre></td></tr></table></figure>

<p>:star:最后运行脚本即可</p>
<h3 id="8-前端通过代理解决跨域-vite"><a href="#8-前端通过代理解决跨域-vite" class="headerlink" title="8.前端通过代理解决跨域-vite"></a>8.前端通过代理解决跨域-vite</h3><p>:star:在<code>vite.config.ts</code>文件中加上 <strong>server</strong> 内容：<strong>（最好只在开发时使用，正式环境建议不要使用）</strong></p>
<p>:star:同时需要将<code>request.ts</code>中的 <strong>baseURL</strong> 改为空：<code>baseURL: &quot;&quot;</code>，这样请求地址才会和前端一样</p>
<p>:star:若是后端配置了解决跨域问题的配置，请注释掉</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; fileURLToPath, <span class="hljs-variable constant_">URL</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;node:url&quot;</span>;<br><br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vite&quot;</span>;<br><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@vitejs/plugin-vue&quot;</span>;<br><span class="hljs-keyword">import</span> vueDevTools <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vite-plugin-vue-devtools&quot;</span>;<br><br><span class="hljs-comment">// https://vite.dev/config/</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">server</span>: &#123;<br>    <span class="hljs-comment">//通过代理，将/api的请求转发到localhost的8080端口，解决跨域问题</span><br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&quot;/api&quot;</span>: <span class="hljs-string">&quot;http://localhost:8080&quot;</span>,<br>    &#125;,<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>(), <span class="hljs-title function_">vueDevTools</span>()],<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-string">&quot;@&quot;</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&quot;./src&quot;</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),<br>    &#125;,<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>:star:除了 <strong>vite</strong> 可以配置代理，还有其他第三方工具，比如 <strong>Whistle</strong></p>
<h3 id="9-pinia-全局状态管理-比-vuex-更加好用"><a href="#9-pinia-全局状态管理-比-vuex-更加好用" class="headerlink" title="9.pinia 全局状态管理-比 vuex 更加好用"></a>9.pinia 全局状态管理-比 vuex 更加好用</h3><p>在创建项目的时候就已经整合了 pinia，因此无需额外的安装</p>
<p>:star:使用</p>
<ol>
<li><p>在 <code>src</code> 下创建一个 <code>stores</code> 目录（由于创建项目的时候直接整合了 pinia，因此项目初始化后自动创建该目录，且里面会有一个示例代码 counter.ts）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; ref, computed &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; defineStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;pinia&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&quot;counter&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//初始化变量</span><br>  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>); <span class="hljs-comment">//定义变量获取的方式 类似getter</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//改变变量的函数</span><br>    count.<span class="hljs-property">value</span>++;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> &#123; count, doubleCount, increment &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure></li>
</ol>
<p>:star:此处使用其对用户登陆信息进行全局统一管理</p>
<ol>
<li><p>在 <code>stroes</code> 目录下创建 <code>useLoginUserStore.ts</code> 文件，文件内容如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; ref, computed &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; defineStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;pinia&quot;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 存储用户登陆信息的状态</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useLoginUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&quot;loginUser&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> loginUser = ref&lt;<span class="hljs-built_in">any</span>&gt;(&#123;<br>    <span class="hljs-attr">userName</span>: <span class="hljs-string">&quot;未登录&quot;</span>,<br>  &#125;);<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 设置登陆用户</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> newLoginUser 获取到的用户</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setLoginUser</span>(<span class="hljs-params"><span class="hljs-attr">newLoginUser</span>: <span class="hljs-built_in">any</span></span>) &#123;<br>    loginUser.<span class="hljs-property">value</span> = newLoginUser;<br>  &#125;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取登陆用户（调用后端接口）</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchLoginUser</span>(<span class="hljs-params"></span>) &#123;&#125;<br><br>  <span class="hljs-keyword">return</span> &#123; loginUser, setLoginUser, fetchLoginUser &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure>
</li>
<li><p>使用方式</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> loginUserStore = <span class="hljs-title function_">useLoginUserStore</span>();<br>loginUserStore.<span class="hljs-title function_">fetchLoginUser</span>();<br>loginUserStore.<span class="hljs-title function_">setLoginUser</span>();<br><span class="hljs-keyword">const</span> loginUser = loginUserStore.<span class="hljs-property">loginUser</span>;<br></code></pre></td></tr></table></figure></li>
</ol>
<h1 id="开发过程的功能解读"><a href="#开发过程的功能解读" class="headerlink" title="开发过程的功能解读"></a>开发过程的功能解读</h1><h2 id="用户的权限控制"><a href="#用户的权限控制" class="headerlink" title="用户的权限控制"></a>用户的权限控制</h2><p>可以将接口分为四种权限：</p>
<ol>
<li>未登陆也能使用</li>
<li>登陆用户才能使用</li>
<li>未登录也能使用，但是登录的用户能进行更多的操作（比如登陆后的查看全文）</li>
<li>仅管理员才能使用</li>
</ol>
<p>:star:传统的权限控制方式是：在每个接口内单独编写逻辑，先获取到当前登陆用户的信息，然后判断用户的权限是否符合要求<br>这种方式虽然最灵活，但是会写很多重复代码，且其他开发者无法一眼得知接口所需要的权限</p>
<p>:star:权限校验其实是一种比较通用的业务需求，一般通过 <strong>Spring AOP</strong> 切面 + <strong>自定义权限校验注解</strong> 实现统一的接口拦截和权限校验；若有特殊的权限校验逻辑，再在接口中单独编码；</p>
<p>:star:若是需要更加复杂灵活的权限控制，可以引入 <strong>Shiro</strong> &#x2F; <strong>Spring Security</strong> &#x2F; Sa-Token 等专门的权限管理框架</p>
<h2 id="通用增删改查方法的实现-MybatisX"><a href="#通用增删改查方法的实现-MybatisX" class="headerlink" title="通用增删改查方法的实现-MybatisX"></a>通用增删改查方法的实现-MybatisX</h2><p>MybatisX 是一款 idea 的插件</p>
<ol>
<li>首先安装插件</li>
<li>在对应的表中右键即可<img src="/staticImg/image-20250312204132204.png" alt="image-20250312204132204" style="zoom: 50%;" /></li>
<li>选择对应的项目目录，以及需要将代码生成在哪个包下，接着 next（<strong>对于生成位置，建议先保持默认，后面检查代码没有问题再移动到正确的位置</strong>）<img src="/staticImg/image-20250312204313463.png" alt="image-20250312204313463" style="zoom:50%;" /></li>
<li>选择合适的框架版本—–finish 即可<img src="/staticImg/image-20250312205057857.png" alt="image-20250312205057857" style="zoom:50%;" /></li>
</ol>
<h1 id="Idea-好用插件"><a href="#Idea-好用插件" class="headerlink" title="Idea 好用插件"></a>Idea 好用插件</h1><h2 id="1-MybatisX"><a href="#1-MybatisX" class="headerlink" title="1.MybatisX"></a>1.MybatisX</h2><p>根据数据库表自动生成实体类，mapper, service 等</p>
<h3 id="1）3-5-9-版本及以上分页有改变"><a href="#1）3-5-9-版本及以上分页有改变" class="headerlink" title="1）3.5.9 版本及以上分页有改变"></a>1）3.5.9 版本及以上分页有改变</h3><p>需要分开引入分页插件依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- MyBatis Plus 分页插件 --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-jsqlparser-4.9<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>分页配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.config;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;<br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@MapperScan(&quot;com.xin.xinpicturebackend.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisPlusConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 拦截器配置</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> MybatisPlusInterceptor&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        <span class="hljs-comment">// 分页插件</span><br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2）前后端数据精度不一致问题（前端丢失精度）"><a href="#2）前后端数据精度不一致问题（前端丢失精度）" class="headerlink" title="2）前后端数据精度不一致问题（前端丢失精度）"></a>2）前后端数据精度不一致问题（前端丢失精度）</h3><p>问题分析：后端数据的 id 使用的是<code>Long</code>类型，而前端 js 精度不够，因此数据无法显示完全</p>
<p>解决方式：增加全局配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Spring MVC Json 配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@JsonComponent</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加 Long 转 json 精度丢失的配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ObjectMapper <span class="hljs-title function_">jacksonObjectMapper</span><span class="hljs-params">(Jackson2ObjectMapperBuilder builder)</span> &#123;<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> builder.createXmlMapper(<span class="hljs-literal">false</span>).build();<br>        <span class="hljs-type">SimpleModule</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleModule</span>();<br>        <span class="hljs-keyword">module</span>.addSerializer(Long.class, ToStringSerializer.instance);<br>        <span class="hljs-keyword">module</span>.addSerializer(Long.TYPE, ToStringSerializer.instance);<br>        objectMapper.registerModule(<span class="hljs-keyword">module</span>);<br>        <span class="hljs-keyword">return</span> objectMapper;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-Generate-All-Getter-And-Setter"><a href="#2-Generate-All-Getter-And-Setter" class="headerlink" title="2.Generate All Getter And Setter"></a>2.Generate All Getter And Setter</h2><p>.allget 自动生成所有 get 语句</p>
<h1 id="前端工具库"><a href="#前端工具库" class="headerlink" title="前端工具库"></a>前端工具库</h1><h2 id="1-前端下载库-file-saver"><a href="#1-前端下载库-file-saver" class="headerlink" title="1.前端下载库-file-saver"></a>1.前端下载库-file-saver</h2><h3 id="1）安装依赖"><a href="#1）安装依赖" class="headerlink" title="1）安装依赖"></a>1）安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install file-saver<br>npm i --save-dev @types/file-saver<br></code></pre></td></tr></table></figure>

<h3 id="2）示例代码"><a href="#2）示例代码" class="headerlink" title="2）示例代码"></a>2）示例代码</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载图片</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> url 图片下载地址</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> fileName 要保存为的文件名</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadImage</span>(<span class="hljs-params"><span class="hljs-attr">url</span>?: <span class="hljs-built_in">string</span>, <span class="hljs-attr">fileName</span>?: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (!url) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-title function_">saveAs</span>(url, fileName);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="后端工具库"><a href="#后端工具库" class="headerlink" title="后端工具库"></a>后端工具库</h1><h2 id="1-html-解析库（java）-jsoup-库"><a href="#1-html-解析库（java）-jsoup-库" class="headerlink" title="1.html 解析库（java）-jsoup 库"></a>1.html 解析库（java）-jsoup 库</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- HTML 解析：https://jsoup.org/ --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.15.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h1 id="项目优化思路"><a href="#项目优化思路" class="headerlink" title="项目优化思路"></a>项目优化思路</h1><h2 id="1-查询优化"><a href="#1-查询优化" class="headerlink" title="1.查询优化"></a>1.查询优化</h2><p>分布式缓存、本地缓存、多级缓存</p>
<h3 id="1-1-缓存-使用场景"><a href="#1-1-缓存-使用场景" class="headerlink" title="1.1 缓存-使用场景"></a>1.1 缓存-使用场景</h3><p>对于经常访问的数据，可以利用性能更高的存储来提高系统的响应速度，俗称 <strong>缓存</strong></p>
<p>使用缓存的情景：<code>读多写少</code></p>
<p>具体来说：</p>
<ol>
<li>高频访问的数据：系统首页、热门推荐内容等</li>
<li>计算成本较高的数据：如复杂查询结果、大量数据的统计结果</li>
<li>允许短时间延迟的数据：如不需要实时更新的排行榜、图片列表等</li>
</ol>
<p>在<code>云图库</code>项目中，主页是用户<strong>高频访问</strong>的内容，调用的获取图片列表的接口也是<strong>高频访问</strong>的，而且即使数据更新存在一定延迟，也不会对用户体验造成明显影响，因此非常适合缓存</p>
<h3 id="1-2-分布式缓存-Redis-分布式缓存"><a href="#1-2-分布式缓存-Redis-分布式缓存" class="headerlink" title="1.2 分布式缓存-Redis 分布式缓存"></a>1.2 分布式缓存-Redis 分布式缓存</h3><p>分布式缓存是指将缓存数据分布存储在 <strong>多台服务器</strong> 上，以便在高并发场景下提供更高的吞吐量和更好的容错性。</p>
<p>Redis 是实现分布式缓存的主流方案，主要由于其具有以下优势：</p>
<ol>
<li>高性能：基于内存操作，访问速度极快！<strong>单节点 Redis 的读写 QPS 可达 10w 次&#x2F;秒</strong></li>
<li>丰富的数据结构：支持字符串、列表、集合、哈希、位图等，适用于各种数据结构存储</li>
<li>分布式支持：可以通过 Redis Cluster 构建高可用、高性能的分布式缓存，还提供哨兵集群机制提升可用性、提供分片集群机制提高可扩展性。</li>
</ol>
<h3 id="1-3-缓存设计-以云图库项目为例"><a href="#1-3-缓存设计-以云图库项目为例" class="headerlink" title="1.3 缓存设计-以云图库项目为例"></a>1.3 缓存设计-以云图库项目为例</h3><p>需要缓存首页的图片列表数据，也就是对 <strong>listPictureVOByPage</strong> 接口进行缓存；<code>缓存设计三要素：key、value、过期时间</code></p>
<ol>
<li><p>缓存 key 设计<br>由于接口支持传入不同的查询条件，对应的数据不同，因此需要将查询条件作为缓存 key 的一部分。<br>可以将查询条件对象转换成为 JSON 对象，<strong>但这个 JSON 会比较长，可以利用哈希算法（md5）来压缩 key</strong><br>此外，由于使用分布式缓存，可能由多个项目和业务共享，因此需要在 key 的开头拼接前缀进行隔离，设计出的 key 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">xinpicture:listPictureVOByPage:$&#123;查询条件key&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>缓存 value 设计<br>缓存从数据库中查到的 Page 分页对象，存储的格式有 2 中选择：<br>1）为了可读性，可以转换成 JSON 结构的字符串<br>2）为了压缩空间，可以存为二进制等其他结构<br>但是，最终 value 的存储结构为 string</p>
</li>
<li><p>缓存过期时间设置<br><code>一定要设置缓存过期时间</code>，根据实际业务场景和缓存空间的大小，数据的一致性要求设置，合适即可，此项目由于查询条件较多，而且考虑到图片会持续更新，因此<strong>设置为 5~60 分钟</strong>即可</p>
</li>
</ol>
<h3 id="1-4-实际操作-redis-缓存"><a href="#1-4-实际操作-redis-缓存" class="headerlink" title="1.4 实际操作-redis 缓存"></a>1.4 实际操作-redis 缓存</h3><p>:star:首先引入依赖-springBoot 集成的 data Redis</p>
<p>由于 springBoot 集成了，因此不用指定版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Redis --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>:star:文件配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment"># Redis 配置</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure>

<p>:star:代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分页获取图片列表：脱敏版使用缓存)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureQueryRequest 查询图片请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request 当前请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 脱敏后分页图片列表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/list/page/vo/cache&quot;)</span><br>    <span class="hljs-keyword">public</span> BaseResponse&lt;Page&lt;PictureVO&gt;&gt; <span class="hljs-title function_">listPictureVOByPageWithCache</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> PictureQueryRequest pictureQueryRequest, HttpServletRequest request)</span> &#123;<br>        ThrowUtils.throwIf(pictureQueryRequest == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> pictureQueryRequest.getCurrent();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> pictureQueryRequest.getPageSize();<br>        <span class="hljs-comment">//限制爬虫</span><br>        ThrowUtils.throwIf(size &gt; PictureConstant.GET_IMG_LIMIT_NUM, ErrorCode.PARAMS_ERROR);<br><br>        <span class="hljs-comment">//普通用户默认只能看到 审核通过 的图片</span><br>        pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());<br><br>        <span class="hljs-comment">//==================redis缓存 start=======================================</span><br>        <span class="hljs-comment">//查询数据库前，先查询缓存，若是缓存未命中再查数据库</span><br>        <span class="hljs-comment">//TODO 可以抽取成一个manager</span><br>        <span class="hljs-comment">//1.构建缓存key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queryCondition</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureQueryRequest);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashKey</span> <span class="hljs-operator">=</span> DigestUtils.md5DigestAsHex(queryCondition.getBytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;xinpicture:listPictureVOByPage:%s&quot;</span>,hashKey);<br>        ValueOperations&lt;String, String&gt; opsForValue = stringRedisTemplate.opsForValue();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> opsForValue.get(redisKey);<br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(cachedValue)) &#123;<br>            <span class="hljs-comment">//命中缓存</span><br>            Page&lt;PictureVO&gt; cachePage = JSONUtil.toBean(cachedValue, Page.class);<br>            <span class="hljs-comment">//直接返回缓存</span><br>            <span class="hljs-keyword">return</span> ResultUtils.success(cachePage);<br>        &#125;<br>        <span class="hljs-comment">//==================redis缓存 end=======================================</span><br><br>        <span class="hljs-comment">//查询数据库</span><br>        Page&lt;Picture&gt; picturePage = pictureService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size), pictureService.getQueryWrapper(pictureQueryRequest));<br>        <span class="hljs-comment">//获取脱敏后的信息</span><br>        Page&lt;PictureVO&gt; pictureVOPage = pictureService.getPictureVOPage(picturePage, request);<br><br>        <span class="hljs-comment">//==================redis缓存 start=======================================</span><br>        <span class="hljs-comment">//将数据存入redis缓存并设置过期时间 5-10分钟</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheValue</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureVOPage);<br>        <span class="hljs-comment">//防止缓存雪崩，过期时间设置随机值</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">cacheExpireTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span> + RandomUtil.randomInt(<span class="hljs-number">0</span>,<span class="hljs-number">300</span>);<br>        opsForValue.set(redisKey, cacheValue, cacheExpireTime, TimeUnit.SECONDS);<br>        <span class="hljs-comment">//==================redis缓存 end=======================================</span><br><br>        <span class="hljs-keyword">return</span> ResultUtils.success(pictureVOPage);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>:star:性能效果</p>
<p>提高一倍（耗时）</p>
<h3 id="1-5-实际操作-本地缓存-Caffeine"><a href="#1-5-实际操作-本地缓存-Caffeine" class="headerlink" title="1.5 实际操作-本地缓存 Caffeine"></a>1.5 实际操作-本地缓存 Caffeine</h3><p>当需要频繁访问某些数据时，可以将这些数据缓存到应用的缓存中（如 JVM）,下次访问直接从内存中获取，而不需要经过网络或其他存储系统</p>
<p>相较于分布式缓存，本地缓存的速度更快，但是无法在多个服务器间共享数据，而且不方便扩容，因此本地缓存的应用场景一般是：</p>
<ol>
<li>数据量访问有限的小型数据集</li>
<li>不需要服务器间共享数据的单机应用</li>
<li>高频、低延迟的访问场景（如用户的临时会话信息，短期热点数据）</li>
</ol>
<p>对于 java 项目， <strong>Caffeine</strong> 是主流的本地缓存技术，拥有极高的性能和丰富的功能。比如可以精确控制缓存数量和大小，支持缓存过期、支持多种缓存淘汰策略，支持异步操作、线程安全等</p>
<p><code>由于本地缓存不需要引入额外的中间件、成本更低。因此如果只是想要提升数据访问性能，优先考虑本地缓存而不是分布式缓存。</code></p>
<h4 id="1-5-1-缓存设计"><a href="#1-5-1-缓存设计" class="headerlink" title="1.5.1 缓存设计"></a>1.5.1 缓存设计</h4><p>本地缓存设计和分布式缓存基本一致，只有 2 个区别：</p>
<ol>
<li>本地缓存需要自己创建初始化缓存结构（可以简单理解为要自己 new 一个 HashMap）</li>
<li>由于本地缓存本身就是服务器隔离的，而且占用服务器内存，key 可以更加精简一些，节省内存</li>
</ol>
<h4 id="1-5-2-开发-java"><a href="#1-5-2-开发-java" class="headerlink" title="1.5.2 开发-java"></a>1.5.2 开发-java</h4><p>:star:引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 本地缓存 Caffeine --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>:star:接口开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 本地缓存初始化</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, String&gt; LOCAL_CACHE = Caffeine.newBuilder()<br>            .initialCapacity(<span class="hljs-number">1024</span>)<br>            .maximumSize(<span class="hljs-number">10_000L</span>)  <span class="hljs-comment">//最大1w条数据</span><br>            .expireAfterWrite(Duration.ofMinutes(<span class="hljs-number">5</span>))  <span class="hljs-comment">//缓存5分钟之后过期</span><br>            .build();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分页获取图片列表：脱敏版使用缓存)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureQueryRequest 查询图片请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request 当前请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 脱敏后分页图片列表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/list/page/vo/caffe&quot;)</span><br>    <span class="hljs-keyword">public</span> BaseResponse&lt;Page&lt;PictureVO&gt;&gt; <span class="hljs-title function_">listPictureVOByPageWithCaffeCache</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> PictureQueryRequest pictureQueryRequest, HttpServletRequest request)</span> &#123;<br>        ThrowUtils.throwIf(pictureQueryRequest == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> pictureQueryRequest.getCurrent();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> pictureQueryRequest.getPageSize();<br>        <span class="hljs-comment">//限制爬虫</span><br>        ThrowUtils.throwIf(size &gt; PictureConstant.GET_IMG_LIMIT_NUM, ErrorCode.PARAMS_ERROR);<br><br>        <span class="hljs-comment">//普通用户默认只能看到 审核通过 的图片</span><br>        pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());<br><br>        <span class="hljs-comment">//==================caffeine缓存 start=======================================</span><br>        <span class="hljs-comment">//查询数据库前，先查询缓存，若是缓存未命中再查数据库</span><br>        <span class="hljs-comment">//TODO 可以抽取成一个manager</span><br>        <span class="hljs-comment">//1.构建缓存key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queryCondition</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureQueryRequest);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashKey</span> <span class="hljs-operator">=</span> DigestUtils.md5DigestAsHex(queryCondition.getBytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;listPictureVOByPage:%s&quot;</span>,hashKey);<br>        <span class="hljs-comment">//从本地缓存中获取</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> LOCAL_CACHE.getIfPresent(cacheKey);<br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(cachedValue)) &#123;<br>            <span class="hljs-comment">//命中缓存</span><br>            Page&lt;PictureVO&gt; cachePage = JSONUtil.toBean(cachedValue, Page.class);<br>            <span class="hljs-comment">//直接返回缓存</span><br>            <span class="hljs-keyword">return</span> ResultUtils.success(cachePage);<br>        &#125;<br>        <span class="hljs-comment">//==================caffeine缓存 end=======================================</span><br><br>        <span class="hljs-comment">//查询数据库</span><br>        Page&lt;Picture&gt; picturePage = pictureService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size), pictureService.getQueryWrapper(pictureQueryRequest));<br>        <span class="hljs-comment">//获取脱敏后的信息</span><br>        Page&lt;PictureVO&gt; pictureVOPage = pictureService.getPictureVOPage(picturePage, request);<br><br>        <span class="hljs-comment">//==================caffeine缓存 start=======================================</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheValue</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureVOPage);<br>        <span class="hljs-comment">//存入本地缓存</span><br>        LOCAL_CACHE.put(cacheKey, cacheValue);<br>        <span class="hljs-comment">//==================caffeine缓存 end=======================================</span><br><br>        <span class="hljs-keyword">return</span> ResultUtils.success(pictureVOPage);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>:star:扩展</p>
<p>从代码可见，使用 redis 缓存和本地缓存的接口代码基本一致，因此可以使用 <strong>策略模式</strong> 或者 **模板方法 **来灵活切换缓存方式</p>
<h2 id="1-6-多级缓存"><a href="#1-6-多级缓存" class="headerlink" title="1.6 多级缓存"></a>1.6 多级缓存</h2><p>多级缓存是指结合本地缓存和分布式缓存的优点，构建两级缓存系统，就可以兼顾本地缓存的高性能、以及分布式缓存的数据一致性和可靠性。</p>
<p>多级缓存的工作流程：</p>
<ol>
<li>第一级（Caffeine 本地缓存）：优先从本地缓存中读取数据，如果命中，则直接返回</li>
<li>第二级（Redis 分布式缓存）：如果本地缓存未命中，则查询 Redis 分布式缓存，如果 Redis 分布式缓存，则返回数据并更新本地缓存</li>
<li>数据库查询：如果 Redis 也未命中，则直接查询数据库，并将结果写入 Redis 和本地缓存</li>
</ol>
<img src="/staticImg/image-20250328214609178.png" alt="image-20250328214609178" style="zoom:50%;" />

<p>多级缓存还有一个优势，提升系统的容错性。即使 Redis 出现故障，本地缓存仍可以提供服务，减少对数据库的直接依赖。</p>
<h3 id="1-6-1-实际操作-多级缓存-Caffeine-Redis"><a href="#1-6-1-实际操作-多级缓存-Caffeine-Redis" class="headerlink" title="1.6.1 实际操作-多级缓存-Caffeine + Redis"></a>1.6.1 实际操作-多级缓存-Caffeine + Redis</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 本地缓存初始化</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, String&gt; LOCAL_CACHE = Caffeine.newBuilder()<br>        .initialCapacity(<span class="hljs-number">1024</span>)<br>        .maximumSize(<span class="hljs-number">10_000L</span>)  <span class="hljs-comment">//最大1w条数据</span><br>        .expireAfterWrite(Duration.ofMinutes(<span class="hljs-number">5</span>))  <span class="hljs-comment">//缓存5分钟之后过期</span><br>        .build();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页获取图片列表：脱敏版使用多级缓存)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pictureQueryRequest 查询图片请求</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request 当前请求</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 脱敏后分页图片列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(&quot;/list/page/vo/multicache&quot;)</span><br><span class="hljs-keyword">public</span> BaseResponse&lt;Page&lt;PictureVO&gt;&gt; <span class="hljs-title function_">listPictureVOByPageWithMultiCache</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> PictureQueryRequest pictureQueryRequest, HttpServletRequest request)</span> &#123;<br>    ThrowUtils.throwIf(pictureQueryRequest == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> pictureQueryRequest.getCurrent();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> pictureQueryRequest.getPageSize();<br>    <span class="hljs-comment">//限制爬虫</span><br>    ThrowUtils.throwIf(size &gt; PictureConstant.GET_IMG_LIMIT_NUM, ErrorCode.PARAMS_ERROR);<br><br>    <span class="hljs-comment">//普通用户默认只能看到 审核通过 的图片</span><br>    pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());<br><br>    <span class="hljs-comment">//==================多级缓存 start=======================================</span><br>    <span class="hljs-comment">//查询数据库前，先查询缓存，若是缓存未命中再查数据库</span><br>    <span class="hljs-comment">//TODO 可以抽取成一个manager</span><br>    <span class="hljs-comment">//1.构建缓存key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">queryCondition</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureQueryRequest);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">hashKey</span> <span class="hljs-operator">=</span> DigestUtils.md5DigestAsHex(queryCondition.getBytes());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;xinpicture:listPictureVOByPage:%s&quot;</span>,hashKey);<br>    <span class="hljs-comment">//1.先从本地缓存中获取</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> LOCAL_CACHE.getIfPresent(cacheKey);<br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(cachedValue)) &#123;<br>        <span class="hljs-comment">//命中缓存</span><br>        Page&lt;PictureVO&gt; cachePage = JSONUtil.toBean(cachedValue, Page.class);<br>        <span class="hljs-comment">//直接返回缓存</span><br>        <span class="hljs-keyword">return</span> ResultUtils.success(cachePage);<br>    &#125;<br>    <span class="hljs-comment">//2.本地缓存未命中，继续从Redis中查询</span><br>    ValueOperations&lt;String, String&gt; opsForValue = stringRedisTemplate.opsForValue();<br>    cachedValue = opsForValue.get(cacheKey);<br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(cachedValue)) &#123;<br>        <span class="hljs-comment">//redis缓存命中，更新本地缓存</span><br>        LOCAL_CACHE.put(cacheKey, cachedValue);<br>        Page&lt;PictureVO&gt; cachePage = JSONUtil.toBean(cachedValue, Page.class);<br>        <span class="hljs-comment">//直接返回缓存</span><br>        <span class="hljs-keyword">return</span> ResultUtils.success(cachePage);<br>    &#125;<br>    <span class="hljs-comment">//==================多级缓存 end=======================================</span><br><br>    <span class="hljs-comment">//3.本地缓存和redis均未命中，查询数据库</span><br>    Page&lt;Picture&gt; picturePage = pictureService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size), pictureService.getQueryWrapper(pictureQueryRequest));<br>    <span class="hljs-comment">//获取脱敏后的信息</span><br>    Page&lt;PictureVO&gt; pictureVOPage = pictureService.getPictureVOPage(picturePage, request);<br><br>    <span class="hljs-comment">//==================多级缓存 start=======================================</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheValue</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(pictureVOPage);<br>    <span class="hljs-comment">//更新 Redis 缓存</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">redisCacheExpireTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span> + RandomUtil.randomInt(<span class="hljs-number">0</span>,<span class="hljs-number">300</span>);<br>    opsForValue.set(cacheKey, cacheValue, redisCacheExpireTime, TimeUnit.SECONDS);<br>    <span class="hljs-comment">//更新 本地缓存</span><br>    LOCAL_CACHE.put(cacheKey, cacheValue);<br>    <span class="hljs-comment">//==================多级caffeine缓存 end=======================================</span><br><br>    <span class="hljs-keyword">return</span> ResultUtils.success(pictureVOPage);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="star-扩展"><a href="#star-扩展" class="headerlink" title=":star:扩展"></a>:star:扩展</h2><p>某些情况下，数据更新较为频繁，自动刷新缓存机制可能存在延迟，则可以通过手动刷新来解决，比如：</p>
<ul>
<li>提供一个刷新缓存的接口，仅管理员可调用</li>
<li>提供管理后台，支持管理员手动刷新指定缓存</li>
</ul>
<p>使用 redis 缓存可能出现的问题:</p>
<ul>
<li>缓存击穿：热点 key 过期，大量请求打到数据库</li>
<li>缓存穿透：访问缓存中不存在数据</li>
<li>缓存雪崩：同一时间大量 key 过期</li>
</ul>
<p>自动识别热点图片：</p>
<ul>
<li>可以采用热 key 探测技术，实时对图片的访问量进行统计，并自动将热点图片添加到内存缓存，以应对大量高频的访问</li>
</ul>
<p>查询优化：</p>
<ul>
<li>获取图片列表时，只获取（select）必要的字段</li>
</ul>
<p>代码优化：</p>
<ul>
<li>将缓存的获取和更新抽取成一个公共方法</li>
</ul>
<h2 id="2-文件上传优化-以云图库项目为例"><a href="#2-文件上传优化-以云图库项目为例" class="headerlink" title="2.文件上传优化-以云图库项目为例"></a>2.文件上传优化-以云图库项目为例</h2><p>压缩、秒传、分片上传、断电续传</p>
<h3 id="2-1-图片上传优化"><a href="#2-1-图片上传优化" class="headerlink" title="2.1 图片上传优化"></a>2.1 图片上传优化</h3><p>对于图片网站来说，图片压缩是图片优化中最基本且最重要的操作，能够显著减少图片文件的大小，从而降低带宽使用和流量消耗，大幅降低成本的同时，提高图片加载速度</p>
<p>:star:压缩图片的方式：</p>
<ol>
<li>将图片格式转换为体积更小的格式，比如 Webp 或其他格式</li>
<li>对图片质量进行压缩</li>
<li>缩小图片尺寸</li>
</ol>
<p>对于图片网站来说，尽量不要影响图片质量，因此推荐第一种方法</p>
<p>:star:图片压缩格式</p>
<ol>
<li>webp：谷歌开发的现代图片格式，支持有损和无损压缩，相比传统格式：<br>1）比 PNG 文件小约 26%<br>2）比 JPEG 文件约小 25%-34%<br>3）支持透明背景（Alpha 通道）<br>4）兼容性：大部分主流浏览器均支持</li>
<li>AVIF：基于 AV1 视频编码技术的图片格式，压缩率更高<br>1）比 webp 文件大小更小，画质更优<br>2）支持透明背景和高动态范围（HDR）<br>虽然 AVIF 看起来更牛，但兼容性差，为了不同浏览器能加载，建议选择 <strong>Webp</strong> 格式</li>
</ol>
<p>:star:图片压缩方案</p>
<p>可以使用本地图像处理类库自行操作，也能使用第三方云服务完成，本项目通过阿里云的 oss 中自带的图像处理技术来将图片格式转化成 webp</p>
<p>oss 对象存储提供图像处理功能，只需在对应的 bucket 中配置样式，同时为样式取一个名称，之后就可以在请求 url 中以 query 参数的形式带上样式名称参数（可用?连接，也可自定义分隔符），即可直接获取经过样式处理后的图像。</p>
<h3 id="2-2-扩展"><a href="#2-2-扩展" class="headerlink" title="2.2 扩展"></a>2.2 扩展</h3><ol>
<li>增加对原图的处理<br>此处由于鱼皮老师使用的是腾讯 oss，因此会在 oss 中存储原图和 webp 格式的图片，占用空间大；而使用阿里云能够在获取图片的时候直接通过参数获取处理后的图片，因此 oss 中只要存储原图即可</li>
<li>尝试更大比例的压缩：阿里云 oss 提供了质量压缩</li>
</ol>
<h4 id="2-2-1-扩展知识-文件秒传"><a href="#2-2-1-扩展知识-文件秒传" class="headerlink" title="2.2.1 扩展知识-文件秒传"></a>2.2.1 扩展知识-文件秒传</h4><p>文件秒传是一种基于文件的唯一标识（如 MD5，SHA-256）对文件内容进行快速校验，避免重复上传；在大型文件传输场景下非常重要，可用提高性能，解决资源</p>
<p>文件秒传的实现流程：</p>
<ol>
<li><p>客户端生成文件唯一标识：上传前，通过客户端计算文件的哈希值（MD5，SHA-256），生成文件唯一指纹</p>
</li>
<li><p>服务端校验文件指纹：后端接收到文件指纹后，在存储中查询是否已存在相同文件<br>1）若存在相同文件，则直接返回文件的存储路径<br>2）若不存在，则接收并存储新文件，同时记录指纹信息<br>注意：客户端和服务端是相对的概念，因为我们要把文件上传到对象存储服务器，此时，后端为客户端，对象存储服务为服务端<br>对于 <strong>云图库项目</strong> 给图片表加上 MD5 字段用于存储文件指纹，上传前增加类似的逻辑判断即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 计算文件指纹</span><br><span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> SecureUtil.md5(file);<br><span class="hljs-comment">// 从数据库中查询已有的文件</span><br>List&lt;Picture&gt; pictureList = pictureService.lambdaQuery()<br>        .eq(Picture::getMd5, md5)<br>        .list();<br><span class="hljs-comment">// 文件已存在，秒传</span><br><span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(pictureList)) &#123;<br>    <span class="hljs-comment">// 直接复用已有文件的信息，不必重复上传文件</span><br>    <span class="hljs-type">Picture</span> <span class="hljs-variable">existPicture</span> <span class="hljs-operator">=</span> pictureList.get(<span class="hljs-number">0</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 文件不存在，实际上传逻辑</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>实际使用秒传的限制：</p>
<p>目前的<strong>云图库项目</strong>并不适用文件秒传，主要因为文件较小，重复文件少，优化效果有限，且使用 oss 服务，若是两文件相同，意味着使用的 url 也是一样的，可能会出现其他问题</p>
<h4 id="2-2-2-扩展知识-分片上传和断点续传"><a href="#2-2-2-扩展知识-分片上传和断点续传" class="headerlink" title="2.2.2 扩展知识-分片上传和断点续传"></a>2.2.2 扩展知识-分片上传和断点续传</h4><p>对于大文件可以开启分片上传和断点续传，oss 应该有相应的 sdk,可以查看文档（之前自己写过多线程下载，回头找找把代码贴过来）</p>
<h2 id="3-加载优化"><a href="#3-加载优化" class="headerlink" title="3.加载优化"></a>3.加载优化</h2><p>懒加载、缩略图、CDN 加速、浏览器缓存</p>
<h3 id="3-1-缩略图"><a href="#3-1-缩略图" class="headerlink" title="3.1 缩略图"></a>3.1 缩略图</h3><p>使用阿里 oss 服务可以直接通过 url 对图片进行降质处理</p>
<h3 id="3-2-懒加载-主要针对前端"><a href="#3-2-懒加载-主要针对前端" class="headerlink" title="3.2 懒加载-主要针对前端"></a>3.2 懒加载-主要针对前端</h3><p>懒加载可以避免一次性加载所有图片，只有当资源需要显示时才进行加载，对于图片列表来说，仅在用户滚动到图片所在的区域才加载图片资源</p>
<p>:star:实现方案</p>
<ol>
<li><p>使用 html5 原生的 loading&#x3D;”lazy”</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;image.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;示例图片&quot;</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">&quot;lazy&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>使用 js 的 intersection Observer,该 API 能够检测元素是否进入视口，参考实现：<br>1）将图片真实 src 替换为一个占位属性（如 data-src）<br>2）使用 intersection Observer 监听图片是否进入视口<br>3）当图片进入视口时，将 data-src 的值赋给 src，触发加载</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">&quot;image.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;示例图片&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lazy&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">&quot;image2.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;示例图片&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lazy&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 获取所有需要懒加载的图片</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> lazyImages = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;img.lazy&quot;</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 创建 Intersection Observer</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries, observer</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>;</span><br><span class="language-javascript">        <span class="hljs-comment">// 将 data-src 的值赋给 src 属性</span></span><br><span class="language-javascript">        img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;</span><br><span class="language-javascript">        img.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">&quot;lazy&quot;</span>);</span><br><span class="language-javascript">        observer.<span class="hljs-title function_">unobserve</span>(img); <span class="hljs-comment">// 停止观察已加载的图片</span></span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">    &#125;);</span><br><span class="language-javascript">  &#125;);</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 观察每个图片</span></span><br><span class="language-javascript">  lazyImages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">image</span>) =&gt;</span> observer.<span class="hljs-title function_">observe</span>(image));</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>使用 js 监听页面滚动事件，页面每次滚动时，判断图片是否进入可视区域，如果是，给图片增加 src 属性，触发加载</p>
</li>
<li><p>使用现成组件库实现：比如 lazysizes 库</p>
</li>
</ol>
<h3 id="star-扩展-渐进式加载"><a href="#star-扩展-渐进式加载" class="headerlink" title=":star:扩展-渐进式加载"></a>:star:扩展-渐进式加载</h3><p>该技术和懒加载技术类似，先加载低分辨率或低质量的占位资源，用户访问或等待期间逐步加载高分辨率的完整资源，加载完后再替换占位资源，ant-design 组件库有支持渐近加载的功能</p>
<h3 id="3-3CDN-加速"><a href="#3-3CDN-加速" class="headerlink" title="3.3CDN 加速"></a>3.3CDN 加速</h3><p>使用免费的域名托管 CF，里面提供 CDN 服务</p>
<h3 id="3-4-浏览器缓存"><a href="#3-4-浏览器缓存" class="headerlink" title="3.4 浏览器缓存"></a>3.4 浏览器缓存</h3><p>通过设置 HTTP 头的信息（如 Cache-Control），可以让用户的浏览器将资源存储在本地，用户再次访问资源时，直接从本地加载资源，而无需请求服务器</p>
<p>使用缓存注意事项：</p>
<ol>
<li>设置合理的缓存时间：<br>1）静态资源使用长期缓存，比如：Cache-Control:public, max-age&#x3D;31536000 表示缓存一年<br>2）动态内容使用验证缓存：比如：Cache-Control:private, no-cache 表示缓存可被客户端存储，但每次使用前需要与服务器验证有效性。<br>3）敏感内容禁用缓存：比如：Cache-Control: no-store 表示不允许任何形式的缓存</li>
<li>要及时更新缓存</li>
</ol>
<h2 id="4-文件存储优化"><a href="#4-文件存储优化" class="headerlink" title="4.文件存储优化"></a>4.文件存储优化</h2><p>降频存储（冷热数据分离）、清理策略</p>
<h2 id="5-tips"><a href="#5-tips" class="headerlink" title="5.tips"></a>5.tips</h2><p>其中代码生成器项目有详细的优化过程及使用压测工具进行压测的的过程，<strong>可以参考该项目的优化手段</strong></p>
<h1 id="功能类框架"><a href="#功能类框架" class="headerlink" title="功能类框架"></a>功能类框架</h1><h2 id="1-权限校验框架-Sa-Token"><a href="#1-权限校验框架-Sa-Token" class="headerlink" title="1.权限校验框架-Sa-Token"></a>1.权限校验框架-Sa-Token</h2><h3 id="1-1-官方文档"><a href="#1-1-官方文档" class="headerlink" title="1.1 官方文档"></a>1.1 官方文档</h3><p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/start/example">Sa-Token 官方文档</a></p>
<h3 id="1-2-引入依赖"><a href="#1-2-引入依赖" class="headerlink" title="1.2 引入依赖"></a>1.2 引入依赖</h3><p>注：如果你使用的是 SpringBoot 3.x，只需要将 <code>sa-token-spring-boot-starter</code> 修改为 <code>sa-token-spring-boot3-starter</code> 即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Sa-Token 权限认证，在线文档：https://sa-token.cc --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.42.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="1-3-配置文件"><a href="#1-3-配置文件" class="headerlink" title="1.3 配置文件"></a>1.3 配置文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.auth.annotation;<br><br><span class="hljs-keyword">import</span> cn.dev33.satoken.interceptor.SaInterceptor;<br><span class="hljs-keyword">import</span> cn.dev33.satoken.strategy.SaAnnotationStrategy;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.annotation.AnnotatedElementUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Sa-Token 注解配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaTokenConfigure</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-comment">// 注册 Sa-Token 拦截器，打开注解式鉴权功能</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 注册 Sa-Token 拦截器，打开注解式鉴权功能</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SaInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>);<br>    &#125;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 若是需要使用合并注解，则需要加上下面的配置，同时编写一个自定义注解</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rewriteSaStrategy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 重写Sa-Token的注解处理器，增加注解合并功能</span><br>        SaAnnotationStrategy.instance.getAnnotation = (element, annotationClass) -&gt; &#123;<br>            <span class="hljs-keyword">return</span> AnnotatedElementUtils.getMergedAnnotation(element, annotationClass);<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>自定义注解模板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.auth.annotation;<br><br><span class="hljs-keyword">import</span> cn.dev33.satoken.annotation.SaCheckPermission;<br><span class="hljs-keyword">import</span> cn.dev33.satoken.annotation.SaMode;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.auth.StpKit;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 空间权限认证：必须具有指定权限才能进入该方法</span><br><span class="hljs-comment"> * &lt;p&gt; 可标注在函数、类上（效果等同于标注在此类的所有方法上）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SaCheckPermission(type = StpKit.SPACE_TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SaSpaceCheckPermission &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 需要校验的权限码</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 需要校验的权限码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AliasFor(annotation = SaCheckPermission.class)</span><br>    String[] value() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证模式：AND | OR，默认AND</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 验证模式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AliasFor(annotation = SaCheckPermission.class)</span><br>    SaMode <span class="hljs-title function_">mode</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> SaMode.AND;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在权限校验不通过时的次要选择，两者只要其一校验成功即可通过校验</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * 例1：<span class="hljs-doctag">@SaCheckPermission</span>(value=&quot;user-add&quot;, orRole=&quot;admin&quot;)，</span><br><span class="hljs-comment">     * 代表本次请求只要具有 user-add权限 或 admin角色 其一即可通过校验。</span><br><span class="hljs-comment">     * &lt;/p&gt;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * 例2： orRole = &#123;&quot;admin&quot;, &quot;manager&quot;, &quot;staff&quot;&#125;，具有三个角色其一即可。 &lt;br&gt;</span><br><span class="hljs-comment">     * 例3： orRole = &#123;&quot;admin, manager, staff&quot;&#125;，必须三个角色同时具备。</span><br><span class="hljs-comment">     * &lt;/p&gt;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> /</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AliasFor(annotation = SaCheckPermission.class)</span><br>    String[] orRole() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="1-4-整合-Redis-及将序列化方式转成-jackson"><a href="#1-4-整合-Redis-及将序列化方式转成-jackson" class="headerlink" title="1.4 整合 Redis 及将序列化方式转成 jackson"></a>1.4 整合 Redis 及将序列化方式转成 jackson</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Sa-Token 整合 Redis （使用 jackson 序列化方式） --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-redis-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.39.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 提供Redis连接池 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="1-5-多账号认证体系"><a href="#1-5-多账号认证体系" class="headerlink" title="1.5 多账号认证体系"></a>1.5 多账号认证体系</h3><h4 id="（1）Kit-模式"><a href="#（1）Kit-模式" class="headerlink" title="（1）Kit 模式"></a>（1）Kit 模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * StpLogic 门面类，管理项目中所有的 StpLogic 账号体系</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StpKit</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 默认原生会话对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StpLogic</span> <span class="hljs-variable">DEFAULT</span> <span class="hljs-operator">=</span> StpUtil.stpLogic;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Admin 会话对象，管理 Admin 表所有账号的登录、权限认证</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StpLogic</span> <span class="hljs-variable">ADMIN</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StpLogic</span>(<span class="hljs-string">&quot;admin&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * User 会话对象，管理 User 表所有账号的登录、权限认证</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StpLogic</span> <span class="hljs-variable">USER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StpLogic</span>(<span class="hljs-string">&quot;user&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * XX 会话对象，（项目中有多少套账号表，就声明几个 StpLogic 会话对象）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StpLogic</span> <span class="hljs-variable">XXX</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StpLogic</span>(<span class="hljs-string">&quot;xx&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在需要登陆的地方使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在当前会话进行 Admin 账号登录</span><br>StpKit.ADMIN.login(<span class="hljs-number">10001</span>);<br><br><span class="hljs-comment">// 在当前会话进行 User 账号登录</span><br>StpKit.USER.login(<span class="hljs-number">10001</span>);<br><br><span class="hljs-comment">// 检测当前会话是否以 Admin 账号登录，并具有 article:add 权限</span><br>StpKit.ADMIN.checkPermission(<span class="hljs-string">&quot;article:add&quot;</span>);<br><br><span class="hljs-comment">// 检测当前会话是否以 User 账号登录，并通过了二级认证</span><br>StpKit.USER.checkSafe();<br><br><span class="hljs-comment">// 获取当前 User 会话的 Session 对象，并进行写值操作</span><br>StpKit.USER.getSession().set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zhang&quot;</span>);<br></code></pre></td></tr></table></figure>

<h3 id="1-6-权限认证逻辑"><a href="#1-6-权限认证逻辑" class="headerlink" title="1.6 权限认证逻辑"></a>1.6 权限认证逻辑</h3><p>Sa-Token 开发的核心是编写权限认证类，我们需要在该类中实现“如何根据登陆用户 id 获取到用户已有的角色和权限列表”方法。当要判断某用户是否有某个角色或权限时，Sa-Token 会先执行我们编写的方法，得到该用户的角色或权限列表，然后跟需要的角色权限进行比对。</p>
<p>官方文档示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义权限加载接口实现类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span>    <span class="hljs-comment">// 保证此类被 SpringBoot 扫描，完成 Sa-Token 的自定义权限验证扩展</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StpInterfaceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StpInterface</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 返回一个账号所拥有的权限码集合</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getPermissionList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-comment">// 本 list 仅做模拟，实际项目中要根据具体业务逻辑来查询权限</span><br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        list.add(<span class="hljs-string">&quot;101&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;user.add&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;user.update&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;user.get&quot;</span>);<br>        <span class="hljs-comment">// list.add(&quot;user.delete&quot;);</span><br>        list.add(<span class="hljs-string">&quot;art.*&quot;</span>);<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 返回一个账号所拥有的角色标识集合 (权限与角色可分开校验)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getRoleList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-comment">// 本 list 仅做模拟，实际项目中要根据具体业务逻辑来查询角色</span><br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        list.add(<span class="hljs-string">&quot;admin&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;super-admin&quot;</span>);<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Sa-Token 支持按照角色和权限校验，对于权限不多的项目，基于角色校验即可；对于权限较多的项目，建议根据权限校验。相较于角色，权限校验细粒度更小。</p>
<p>同时，Sa-Token 支持<strong>编程式</strong>和<strong>注解式</strong>鉴权</p>
<h3 id="1-7-图库项目中使用-Sa-Token"><a href="#1-7-图库项目中使用-Sa-Token" class="headerlink" title="1.7 图库项目中使用 Sa-Token"></a>1.7 图库项目中使用 Sa-Token</h3><h4 id="1-7-1-使用过程中的坑-request-的请求体-body-是一个流，只允许读一次"><a href="#1-7-1-使用过程中的坑-request-的请求体-body-是一个流，只允许读一次" class="headerlink" title="1.7.1 使用过程中的坑-request 的请求体(body)是一个流，只允许读一次"></a>1.7.1 使用过程中的坑-request 的请求体(body)是一个流，只允许读一次</h4><p>:star:解决方案-全局配置文件添加以下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 包装请求，使 InputStream 可以重复读取</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> pine</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServletRequestWrapper</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String body;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RequestWrapper</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-built_in">super</span>(request);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> request.getInputStream(); <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream))) &#123;<br>            <span class="hljs-type">char</span>[] charBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">128</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">bytesRead</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> ((bytesRead = bufferedReader.read(charBuffer)) &gt; <span class="hljs-number">0</span>) &#123;<br>                stringBuilder.append(charBuffer, <span class="hljs-number">0</span>, bytesRead);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;<br>        &#125;<br>        body = stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletInputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(body.getBytes());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletInputStream</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFinished</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReady</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadListener</span><span class="hljs-params">(ReadListener readListener)</span> &#123;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-keyword">return</span> byteArrayInputStream.read();<br>            &#125;<br>        &#125;;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BufferedReader <span class="hljs-title function_">getReader</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-built_in">this</span>.getInputStream()));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBody</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.body;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求包装过滤器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> pine</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Order(1)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequestWrapperFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> HttpServletRequest) &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> servletRequest.getHeader(Header.CONTENT_TYPE.getValue());<br>            <span class="hljs-keyword">if</span> (ContentType.JSON.getValue().equals(contentType)) &#123;<br>                <span class="hljs-comment">// 可以再细粒度一些，只有需要进行空间权限校验的接口才需要包一层</span><br>                chain.doFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestWrapper</span>(servletRequest), response);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                chain.doFilter(request, response);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="1-7-2-踩坑记录"><a href="#1-7-2-踩坑记录" class="headerlink" title="1.7.2 踩坑记录"></a>1.7.2 踩坑记录</h4><p>当项目中使用了<code>hutool工具类</code>时，此时使用多账号认证中的注解合并功能时，注解中的<code>@AliasFor</code>要引入<code>org.springframework.core.annotation.AliasFor;</code>而不是<code>hutool</code>工具类中的</p>
<h2 id="2-分库分表框架-Apache-ShardingSphere"><a href="#2-分库分表框架-Apache-ShardingSphere" class="headerlink" title="2.分库分表框架-Apache ShardingSphere"></a>2.分库分表框架-Apache ShardingSphere</h2><h3 id="2-1-分库分表概念"><a href="#2-1-分库分表概念" class="headerlink" title="2.1 分库分表概念"></a>2.1 分库分表概念</h3><p>分库分表是一种将数据拆分到多个数据库或数据表中的设计策略，主要用于解决随着业务数据量和访问量增长带来的数据库性能问题。</p>
<p>通过分库分表，可以减小单库或单表的数据量和访问压力，从而提高查询和写入效率、增强系统的高并发能力、优化大数据量下的性能表现；同时降低单点故障风险，实现更好的系统扩展性和容灾能力</p>
<p>思路主要是基于业务需求设计 <strong>数据分片规则</strong> 将数据按照一定策略（如取模、哈希、范围或时间）分散存储到多个库或表中，同时开发路由逻辑来决定查询或写入操作的目标库表</p>
<p>但是：这只是最简单的情况，实际上，分库分表还涉及跨库表查询，事务一致性、分页聚合等复杂场景，还可能需要配套设计监控、扩容和迁移方案以确保系统的可维护性和扩展性。</p>
<h3 id="2-2-官方文档"><a href="#2-2-官方文档" class="headerlink" title="2.2 官方文档"></a>2.2 官方文档</h3><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/">ShardingSphere 官方文档</a></p>
<p>其提供了开箱即用的分片策略、灵活的配置能力以及对跨库表查询、事务一致性、读写分离等复杂功能的全面支持</p>
<h3 id="2-3-主要功能"><a href="#2-3-主要功能" class="headerlink" title="2.3 主要功能"></a>2.3 主要功能</h3><p><img src="/staticImg/image-20250506215945037.png" alt="image-20250506215945037"></p>
<h3 id="2-4-引入依赖"><a href="#2-4-引入依赖" class="headerlink" title="2.4 引入依赖"></a>2.4 引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 分库分表 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<h3 id="2-5-静态分表和动态分表"><a href="#2-5-静态分表和动态分表" class="headerlink" title="2.5 静态分表和动态分表"></a>2.5 静态分表和动态分表</h3><ol>
<li>静态分表<br>预先知道有多少张表，通过一定的规则将请求路由到不同的表即可</li>
<li>动态分表<br>不清楚有多少张表，表的数量可以根据业务需求或数据量动态增加，表的结构和规则是运行时动态生成的</li>
</ol>
<h3 id="2-6-配置文件"><a href="#2-6-配置文件" class="headerlink" title="2.6 配置文件"></a>2.6 配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment"># 分库分表配置</span><br>  <span class="hljs-attr">shardingsphere:</span><br>    <span class="hljs-attr">datasource:</span><br>      <span class="hljs-attr">names:</span> <span class="hljs-string">xin_picture</span><br>      <span class="hljs-attr">xin_picture:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/xin_picture</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-attr">sharding:</span><br>        <span class="hljs-attr">tables:</span><br>          <span class="hljs-attr">picture:</span><br>            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">xin_picture.picture</span> <span class="hljs-comment"># 动态分表</span><br>            <span class="hljs-attr">table-strategy:</span><br>              <span class="hljs-attr">standard:</span><br>                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">spaceId</span><br>                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">picture_sharding_algorithm</span> <span class="hljs-comment"># 使用自定义分片算法</span><br>        <span class="hljs-attr">sharding-algorithms:</span><br>          <span class="hljs-attr">picture_sharding_algorithm:</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">CLASS_BASED</span><br>            <span class="hljs-attr">props:</span><br>              <span class="hljs-attr">strategy:</span> <span class="hljs-string">standard</span><br>              <span class="hljs-attr">algorithmClassName:</span> <span class="hljs-string">com.xin.xinpicturebackend.manager.sharding.PictureShardingAlgorithm</span><br>    <span class="hljs-attr">props:</span><br>      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#测试环境开启，打印执行的sql</span><br></code></pre></td></tr></table></figure>

<p><code>PictureShardingAlgorithm</code>路由算法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.sharding;<br><br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.PreciseShardingValue;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.RangeShardingValue;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.sharding.standard.StandardShardingAlgorithm;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureShardingAlgorithm</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StandardShardingAlgorithm</span>&lt;Long&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; availableTargetNames, PreciseShardingValue&lt;Long&gt; preciseShardingValue)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">spaceId</span> <span class="hljs-operator">=</span> preciseShardingValue.getValue();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">logicTableName</span> <span class="hljs-operator">=</span> preciseShardingValue.getLogicTableName();<br>        System.out.println(<span class="hljs-string">&quot;路由算法开始====&quot;</span>);<br>        <span class="hljs-comment">// spaceId 为 null 表示查询所有图片</span><br>        <span class="hljs-keyword">if</span> (spaceId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> logicTableName;<br>        &#125;<br>        <span class="hljs-comment">// 根据 spaceId 动态生成分表名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">realTableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;picture_&quot;</span> + spaceId;<br>        <span class="hljs-keyword">if</span> (availableTargetNames.contains(realTableName)) &#123;<br>            <span class="hljs-keyword">return</span> realTableName;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> logicTableName;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;String&gt; <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; collection, RangeShardingValue&lt;Long&gt; rangeShardingValue)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getProps</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Properties properties)</span> &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>由于配置文件没有配置具体的节点，因此需要在项目启动时自动将具体物理表注册到 shardingSphere 的配置文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.sharding;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.SqlRunner;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.ErrorCode;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.enums.SpaceLevelEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.enums.SpaceTypeEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.SpaceService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.driver.jdbc.core.connection.ShardingSphereConnection;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.metadata.database.rule.ShardingSphereRuleMetaData;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.mode.manager.ContextManager;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.config.ShardingRuleConfiguration;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.api.config.rule.ShardingTableRuleConfiguration;<br><span class="hljs-keyword">import</span> org.apache.shardingsphere.sharding.rule.ShardingRule;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.Space;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicShardingManager</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SpaceService spaceService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOGIC_TABLE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;picture&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATABASE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;logic_db&quot;</span>; <span class="hljs-comment">// 配置文件中的数据库名称</span><br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;初始化动态分表配置...&quot;</span>);<br>        updateShardingTableNodes();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取所有动态表名，包括初始表 picture 和分表 picture_&#123;spaceId&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">fetchAllPictureTableNames</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 为了测试方便，直接对所有团队空间分表（实际上线改为仅对旗舰版生效）</span><br>        Set&lt;Long&gt; spaceIds = spaceService.lambdaQuery()<br>                .eq(Space::getSpaceType, SpaceTypeEnum.TEAM.getValue())<br>                .list()<br>                .stream()<br>                .map(Space::getId)<br>                .collect(Collectors.toSet());<br>        Set&lt;String&gt; tableNames = spaceIds.stream()<br>                .map(spaceId -&gt; LOGIC_TABLE_NAME + <span class="hljs-string">&quot;_&quot;</span> + spaceId)<br>                .collect(Collectors.toSet());<br>        tableNames.add(LOGIC_TABLE_NAME); <span class="hljs-comment">// 添加初始逻辑表</span><br>        <span class="hljs-keyword">return</span> tableNames;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新 ShardingSphere 的 actual-data-nodes 动态表名配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateShardingTableNodes</span><span class="hljs-params">()</span> &#123;<br>        Set&lt;String&gt; tableNames = fetchAllPictureTableNames();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">newActualDataNodes</span> <span class="hljs-operator">=</span> tableNames.stream()<br>                .map(tableName -&gt; <span class="hljs-string">&quot;xin_picture.&quot;</span> + tableName) <span class="hljs-comment">// 确保前缀合法</span><br>                .collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>        log.info(<span class="hljs-string">&quot;动态分表 actual-data-nodes 配置: &#123;&#125;&quot;</span>, newActualDataNodes);<br><br>        <span class="hljs-type">ContextManager</span> <span class="hljs-variable">contextManager</span> <span class="hljs-operator">=</span> getContextManager();<br>        <span class="hljs-type">ShardingSphereRuleMetaData</span> <span class="hljs-variable">ruleMetaData</span> <span class="hljs-operator">=</span> contextManager.getMetaDataContexts()<br>                .getMetaData()<br>                .getDatabases()<br>                .get(DATABASE_NAME)<br>                .getRuleMetaData();<br><br>        Optional&lt;ShardingRule&gt; shardingRule = ruleMetaData.findSingleRule(ShardingRule.class);<br>        <span class="hljs-keyword">if</span> (shardingRule.isPresent()) &#123;<br>            <span class="hljs-type">ShardingRuleConfiguration</span> <span class="hljs-variable">ruleConfig</span> <span class="hljs-operator">=</span> (ShardingRuleConfiguration) shardingRule.get().getConfiguration();<br>            List&lt;ShardingTableRuleConfiguration&gt; updatedRules = ruleConfig.getTables()<br>                    .stream()<br>                    .map(oldTableRule -&gt; &#123;<br>                        <span class="hljs-keyword">if</span> (LOGIC_TABLE_NAME.equals(oldTableRule.getLogicTable())) &#123;<br>                            <span class="hljs-type">ShardingTableRuleConfiguration</span> <span class="hljs-variable">newTableRuleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardingTableRuleConfiguration</span>(LOGIC_TABLE_NAME, newActualDataNodes);<br>                            newTableRuleConfig.setDatabaseShardingStrategy(oldTableRule.getDatabaseShardingStrategy());<br>                            newTableRuleConfig.setTableShardingStrategy(oldTableRule.getTableShardingStrategy());<br>                            newTableRuleConfig.setKeyGenerateStrategy(oldTableRule.getKeyGenerateStrategy());<br>                            newTableRuleConfig.setAuditStrategy(oldTableRule.getAuditStrategy());<br>                            <span class="hljs-keyword">return</span> newTableRuleConfig;<br>                        &#125;<br>                        <span class="hljs-keyword">return</span> oldTableRule;<br>                    &#125;)<br>                    .collect(Collectors.toList());<br>            ruleConfig.setTables(updatedRules);<br>            contextManager.alterRuleConfiguration(DATABASE_NAME, Collections.singleton(ruleConfig));<br>            contextManager.reloadDatabase(DATABASE_NAME);<br>            log.info(<span class="hljs-string">&quot;动态分表规则更新成功！&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(<span class="hljs-string">&quot;未找到 ShardingSphere 的分片规则配置，动态分表更新失败。&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 动态创建空间图片分表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> space</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createSpacePictureTable</span><span class="hljs-params">(Space space)</span> &#123;<br>        <span class="hljs-comment">// 仅为旗舰版团队空间创建分表</span><br>        <span class="hljs-keyword">if</span> (space.getSpaceType() == SpaceTypeEnum.TEAM.getValue() &amp;&amp; space.getSpaceLevel() == SpaceLevelEnum.FLAGSHIP.getValue()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> LOGIC_TABLE_NAME + <span class="hljs-string">&quot;_&quot;</span> + space.getId();<br>            <span class="hljs-comment">//创建新表</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">createTableSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CREATE TABLE &quot;</span> + tableName + <span class="hljs-string">&quot; LIKE &quot;</span> + LOGIC_TABLE_NAME;<br>            <span class="hljs-keyword">try</span>  &#123;<br>                SqlRunner.db().update(createTableSql);<br>                <span class="hljs-comment">//更新分表(每次创建完表后，需要将新的表也加入到配置中)</span><br>                updateShardingTableNodes();<br>                log.info(<span class="hljs-string">&quot;创建空间图片分表成功：&#123;&#125;&quot;</span>, tableName);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>                log.error(<span class="hljs-string">&quot;创建空间图片分表失败：&#123;&#125;&quot;</span>, tableName, e);<br>                <span class="hljs-comment">//抛出异常，让外层事务能够感知从而进行回滚</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;创建空间图片分表失败&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取 ShardingSphere ContextManager</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ContextManager <span class="hljs-title function_">getContextManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ShardingSphereConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection().unwrap(ShardingSphereConnection.class)) &#123;<br>            <span class="hljs-keyword">return</span> connection.getContextManager();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;获取 ShardingSphere ContextManager 失败&quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="2-7-注意事项"><a href="#2-7-注意事项" class="headerlink" title="2.7 注意事项"></a>2.7 注意事项</h3><ul>
<li>当配置将某张表的某个字段作为分片字段时，只有当<code>sql</code>中的条件涉及到该字段时，才会触发分片算法</li>
<li>一旦使用该框架，则数据库中所有表的操作都会被其拦截（即 sql 会有<code>逻辑sql</code>和<code>实际sql</code>）</li>
<li>若是将某张表进行分表操作，当查询该表的<code>sql</code>语句中不含分片字段，则默认全表路由，所有表的结果使用 <code>union all</code> 进行汇总</li>
</ul>
<h2 id="3-高性能并发框架（无锁队列）-Disruptor"><a href="#3-高性能并发框架（无锁队列）-Disruptor" class="headerlink" title="3.高性能并发框架（无锁队列）-Disruptor"></a>3.高性能并发框架（无锁队列）-Disruptor</h2><h3 id="3-1-介绍"><a href="#3-1-介绍" class="headerlink" title="3.1 介绍"></a>3.1 介绍</h3><p>其是一种 <strong>无锁的环形队列</strong> 数据结构，用于解决高吞吐量和低延迟场景中的并发问题。支持生产者-消费者模式，可作为消息队列使用，适用于金融交易、实时数据处理、游戏事件等对并发和实时性要求较高的场景，其最大的特点就是：<strong>延迟低，非常低</strong></p>
<h3 id="3-2-引入依赖"><a href="#3-2-引入依赖" class="headerlink" title="3.2 引入依赖"></a>3.2 引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 高性能无锁队列 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.lmax<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>disruptor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-配置类"><a href="#3-3-配置类" class="headerlink" title="3.3 配置类"></a>3.3 配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket.disruptor;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.thread.ThreadFactoryBuilder;<br><span class="hljs-keyword">import</span> com.lmax.disruptor.dsl.Disruptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureEditEventDisruptorConfig</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PictureEditEventWorkHandler pictureEditEventWorkHandler;<br><br>    <span class="hljs-meta">@Bean(&quot;pictureEditEventDisruptor&quot;)</span><br>    <span class="hljs-keyword">public</span> Disruptor&lt;PictureEditEvent&gt; <span class="hljs-title function_">messageModelRingBuffer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// ringBuffer 的大小</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">bufferSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">256</span>;<br>        Disruptor&lt;PictureEditEvent&gt; disruptor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Disruptor</span>&lt;&gt;(<br>                PictureEditEvent::<span class="hljs-keyword">new</span>,<br>                bufferSize,<br>                ThreadFactoryBuilder.create().setNamePrefix(<span class="hljs-string">&quot;pictureEditEventDisruptor&quot;</span>).build()<br>        );<br>        <span class="hljs-comment">// 设置消费者</span><br>        disruptor.handleEventsWithWorkerPool(pictureEditEventWorkHandler);<br>        <span class="hljs-comment">// 开启 disruptor</span><br>        disruptor.start();<br>        <span class="hljs-keyword">return</span> disruptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>:star:定义消息事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket.disruptor;<br><br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditRequestMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.User;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureEditEvent</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> PictureEditRequestMessage pictureEditRequestMessage;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前用户的 session</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> WebSocketSession session;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前用户</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> User user;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片 id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long pictureId;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:定义消息处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket.disruptor;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.lmax.disruptor.WorkHandler;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.PictureEditHandler;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditMessageTypeEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditRequestMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditResponseMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.User;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.UserService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Lazy;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.TextMessage;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureEditEventWorkHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WorkHandler</span>&lt;PictureEditEvent&gt; &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-meta">@Lazy</span><br>    <span class="hljs-keyword">private</span> PictureEditHandler pictureEditHandler;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(PictureEditEvent event)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">PictureEditRequestMessage</span> <span class="hljs-variable">pictureEditRequestMessage</span> <span class="hljs-operator">=</span> event.getPictureEditRequestMessage();<br>        <span class="hljs-type">WebSocketSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> event.getSession();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> event.getUser();<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> event.getPictureId();<br>        <span class="hljs-comment">// 获取到消息类别</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> pictureEditRequestMessage.getType();<br>        <span class="hljs-type">PictureEditMessageTypeEnum</span> <span class="hljs-variable">pictureEditMessageTypeEnum</span> <span class="hljs-operator">=</span> PictureEditMessageTypeEnum.valueOf(type);<br>        <span class="hljs-comment">// 调用对应的消息处理方法</span><br>        <span class="hljs-keyword">switch</span> (pictureEditMessageTypeEnum) &#123;<br>            <span class="hljs-keyword">case</span> ENTER_EDIT:<br>                pictureEditHandler.handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> EDIT_ACTION:<br>                pictureEditHandler.handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> EXIT_EDIT:<br>                pictureEditHandler.handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>                pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());<br>                pictureEditResponseMessage.setMessage(<span class="hljs-string">&quot;消息类型错误&quot;</span>);<br>                pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>                session.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(JSONUtil.toJsonStr(pictureEditResponseMessage)));<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:定义消息生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket.disruptor;<br><br><span class="hljs-keyword">import</span> com.lmax.disruptor.RingBuffer;<br><span class="hljs-keyword">import</span> com.lmax.disruptor.dsl.Disruptor;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditRequestMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.User;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;<br><br><span class="hljs-keyword">import</span> javax.annotation.PreDestroy;<br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureEditEventProducer</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    Disruptor&lt;PictureEditEvent&gt; pictureEditEventDisruptor;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishEvent</span><span class="hljs-params">(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId)</span> &#123;<br>        RingBuffer&lt;PictureEditEvent&gt; ringBuffer = pictureEditEventDisruptor.getRingBuffer();<br>        <span class="hljs-comment">// 获取可以生成的位置</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> ringBuffer.next();<br>        <span class="hljs-type">PictureEditEvent</span> <span class="hljs-variable">pictureEditEvent</span> <span class="hljs-operator">=</span> ringBuffer.get(next);<br>        pictureEditEvent.setSession(session);<br>        pictureEditEvent.setPictureEditRequestMessage(pictureEditRequestMessage);<br>        pictureEditEvent.setUser(user);<br>        pictureEditEvent.setPictureId(pictureId);<br>        <span class="hljs-comment">// 发布事件</span><br>        ringBuffer.publish(next);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 优雅停机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        pictureEditEventDisruptor.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后在生产消息的代码中直接通过配置类中的<code>pictureEditEventDisruptor</code>发布任务即可</p>
<h1 id="拓展小知识（功能）"><a href="#拓展小知识（功能）" class="headerlink" title="拓展小知识（功能）"></a>拓展小知识（功能）</h1><h2 id="1-WebSocket"><a href="#1-WebSocket" class="headerlink" title="1.WebSocket"></a>1.WebSocket</h2><p>全双工的长连接</p>
<h3 id="1-1SpringBoot-中集成原生-WebSocket-引入依赖"><a href="#1-1SpringBoot-中集成原生-WebSocket-引入依赖" class="headerlink" title="1.1SpringBoot 中集成原生 WebSocket-引入依赖"></a>1.1SpringBoot 中集成原生 WebSocket-引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- websocket --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="1-2-配置类"><a href="#1-2-配置类" class="headerlink" title="1.2 配置类"></a>1.2 配置类</h3><p>:star:配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * WebSocket配置类(定义连接)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSocket</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PictureEditHandler pictureEditHandler;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> WsHandshakeInterceptor wsHandshakeInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> &#123;<br>        registry.addHandler(pictureEditHandler, <span class="hljs-string">&quot;/ws/picture/edit&quot;</span>)<br>                .addInterceptors(wsHandshakeInterceptor)<br>                .setAllowedOrigins(<span class="hljs-string">&quot;*&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:配置类中涉及的<code>handler</code>-根据实际业务编写（基于事件驱动的架构）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.collection.CollUtil;<br><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-keyword">module</span>.SimpleModule;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ser.std.ToStringSerializer;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditActionEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditMessageTypeEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditRequestMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.websocket.model.PictureEditResponseMessage;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.User;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.UserService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.CloseStatus;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.TextMessage;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketSession;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.handler.TextWebSocketHandler;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureEditHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextWebSocketHandler</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    UserService userService;<br>    <span class="hljs-comment">// 每张图片的编辑状态，key: pictureId, value: 当前正在编辑的用户 ID</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, Long&gt; pictureEditingUsers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 保存所有连接的会话，key: pictureId, value: 用户会话集合</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, Set&lt;WebSocketSession&gt;&gt; pictureSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 建立连接后处理逻辑</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession session)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">super</span>.afterConnectionEstablished(session);<br>        <span class="hljs-comment">//保存会话到集合中</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) session.getAttributes().get(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> (Long) session.getAttributes().get(<span class="hljs-string">&quot;pictureId&quot;</span>);<br>        pictureSessions.putIfAbsent(pictureId, ConcurrentHashMap.newKeySet());<br>        pictureSessions.get(pictureId).add(session);<br>        <span class="hljs-comment">//构造响应，发送加入编辑的消息通知</span><br>        <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;用户 %s 加入编辑&quot;</span>, user.getUserName());<br>        pictureEditResponseMessage.setMessage(message);<br>        pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>        <span class="hljs-comment">//广播给所有用户</span><br>        broadcastToPicture(pictureId, pictureEditResponseMessage);<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收到消息后的处理的逻辑</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTextMessage</span><span class="hljs-params">(WebSocketSession session, TextMessage message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">super</span>.handleTextMessage(session, message);<br>        <span class="hljs-comment">//获取消息内容，将 Json -&gt; PictureEditResponseMessage 对象</span><br>        <span class="hljs-type">PictureEditRequestMessage</span> <span class="hljs-variable">pictureEditRequestMessage</span> <span class="hljs-operator">=</span> JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> pictureEditRequestMessage.getType();<br>        <span class="hljs-type">PictureEditMessageTypeEnum</span> <span class="hljs-variable">pictureEditMessageTypeEnum</span> <span class="hljs-operator">=</span> PictureEditMessageTypeEnum.getEnumByValue(type);<br><br>        <span class="hljs-comment">//从 session 属性中获取到公共参数</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) session.getAttributes().get(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> (Long) session.getAttributes().get(<span class="hljs-string">&quot;pictureId&quot;</span>);<br><br>        <span class="hljs-comment">//根据消息类型处理消息</span><br>        <span class="hljs-keyword">switch</span> (pictureEditMessageTypeEnum) &#123;<br>            <span class="hljs-keyword">case</span> ENTER_EDIT:<br>                handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> EXIT_EDIT:<br>                handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> EDIT_ACTION:<br>                handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-comment">//其他消息类型，返回错误提示</span><br>                <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>                pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());<br>                pictureEditResponseMessage.setMessage(<span class="hljs-string">&quot;未知的消息类型&quot;</span>);<br>                pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>                session.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(JSONUtil.toJsonStr(pictureEditResponseMessage)));<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 进入编辑状态（同一时间只允许一个用户进入编辑状态）</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureEditRequestMessage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleEnterEditMessage</span><span class="hljs-params">(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 没有用户正在编辑该图片，才能进入编辑</span><br>        <span class="hljs-keyword">if</span> (!pictureEditingUsers.containsKey(pictureId)) &#123;<br>            <span class="hljs-comment">//设置当前用户为正在编辑该图片</span><br>            pictureEditingUsers.put(pictureId, user.getId());<br>            <span class="hljs-comment">//构造响应，发送进入编辑的消息通知</span><br>            <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ENTER_EDIT.getValue());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;用户 %s 开始编辑图片&quot;</span>, user.getUserName());<br>            pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>            pictureEditResponseMessage.setMessage(message);<br>            <span class="hljs-comment">//广播给所有用户</span><br>            broadcastToPicture(pictureId, pictureEditResponseMessage);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 编辑操作</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureEditRequestMessage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleEditActionMessage</span><span class="hljs-params">(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 正在编辑的用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">editingUserId</span> <span class="hljs-operator">=</span> pictureEditingUsers.get(pictureId);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">editAction</span> <span class="hljs-operator">=</span> pictureEditRequestMessage.getEditAction();<br>        <span class="hljs-type">PictureEditActionEnum</span> <span class="hljs-variable">actionEnum</span> <span class="hljs-operator">=</span> PictureEditActionEnum.getEnumByValue(editAction);<br>        <span class="hljs-keyword">if</span> (actionEnum == <span class="hljs-literal">null</span>) &#123;<br>            log.error(<span class="hljs-string">&quot;无效的编辑动作！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//确认是当前的编辑者</span><br>        <span class="hljs-keyword">if</span> (editingUserId != <span class="hljs-literal">null</span> &amp;&amp; editingUserId.equals(user.getId())) &#123;<br>            <span class="hljs-comment">//构造响应，发送具体操作的通知</span><br>            <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EDIT_ACTION.getValue());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;用户 %s 执行了 %s 操作！&quot;</span>, user.getUserName(), actionEnum.getText());<br>            pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>            pictureEditResponseMessage.setMessage(message);<br>            pictureEditResponseMessage.setEditAction(editAction);<br>            <span class="hljs-comment">//广播给所有用户,除了当前正在编辑的用户</span><br>            broadcastToPicture(pictureId, pictureEditResponseMessage, session);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 退出编辑状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureEditRequestMessage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleExitEditMessage</span><span class="hljs-params">(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 正在编辑的用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">editingUserId</span> <span class="hljs-operator">=</span> pictureEditingUsers.get(pictureId);<br>        <span class="hljs-comment">//确认是当前的编辑者</span><br>        <span class="hljs-keyword">if</span> (editingUserId != <span class="hljs-literal">null</span> &amp;&amp; editingUserId.equals(user.getId())) &#123;<br>            <span class="hljs-comment">//移除用户正在编辑该图片</span><br>            pictureEditingUsers.remove(pictureId);<br>            <span class="hljs-comment">//构造响应，发送退出编辑的消息通知</span><br>            <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EXIT_EDIT.getValue());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;用户 %s 退出编辑图片&quot;</span>, user.getUserName());<br>            pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>            pictureEditResponseMessage.setMessage(message);<br>            <span class="hljs-comment">//广播给所有用户</span><br>            broadcastToPicture(pictureId, pictureEditResponseMessage);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 关闭连接</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionClosed</span><span class="hljs-params">(WebSocketSession session, CloseStatus status)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">super</span>.afterConnectionClosed(session, status);<br>        <span class="hljs-comment">//从 session 中获取到公共参数</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User)session.getAttributes().get(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> (Long) session.getAttributes().get(<span class="hljs-string">&quot;pictureId&quot;</span>);<br>        <span class="hljs-comment">//移除当前用户的编辑状态</span><br>        handleExitEditMessage(<span class="hljs-literal">null</span>, session, user, pictureId);<br>        <span class="hljs-comment">//删除会话</span><br>        Set&lt;WebSocketSession&gt; sessionSet = pictureSessions.get(pictureId);<br>        <span class="hljs-keyword">if</span> (sessionSet != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//删除参与该图片编辑的一个会话</span><br>            sessionSet.remove(session);<br>            <span class="hljs-comment">//若是整个会话集合为空，则从移除该图片会话集合</span><br>            <span class="hljs-keyword">if</span> (sessionSet.isEmpty()) &#123;<br>                pictureSessions.remove(pictureId);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 通知其他用户，该用户已经退出编辑会话</span><br>        <span class="hljs-type">PictureEditResponseMessage</span> <span class="hljs-variable">pictureEditResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureEditResponseMessage</span>();<br>        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;用户 %s 退出会话&quot;</span>, user.getUserName());<br>        pictureEditResponseMessage.setUser(userService.getUserVO(user));<br>        pictureEditResponseMessage.setMessage(message);<br>        <span class="hljs-comment">//广播给所有用户</span><br>        broadcastToPicture(pictureId, pictureEditResponseMessage);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将操作广播给该图片的所有用户(支持排除掉某个 Session)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureEditResponseMessage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> excludeSession  排除的 session (用户自己)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastToPicture</span><span class="hljs-params">(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage, WebSocketSession excludeSession)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Set&lt;WebSocketSession&gt; sessionSet = pictureSessions.get(pictureId);<br>        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(sessionSet)) &#123;<br><br>            <span class="hljs-comment">//配置 jackson 序列化器</span><br>            <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>            <span class="hljs-type">SimpleModule</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleModule</span>();<br>            <span class="hljs-comment">//配置序列化器，将 Long 类型转化为 String 类型返回给前端,解决前端处理 Long 类型精度丢失问题</span><br>            <span class="hljs-keyword">module</span>.addSerializer(Long.class, ToStringSerializer.instance);<br>            <span class="hljs-keyword">module</span>.addSerializer(Long.TYPE, ToStringSerializer.instance);<br>            objectMapper.registerModule(<span class="hljs-keyword">module</span>);<br><br>            <span class="hljs-comment">//使用 jackson 序列化器序列化对象为 json 字符串</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(pictureEditResponseMessage);<br>            <span class="hljs-type">TextMessage</span> <span class="hljs-variable">textMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(message);<br>            <span class="hljs-keyword">for</span> (WebSocketSession session : sessionSet) &#123;<br>                <span class="hljs-comment">//排除掉的 session 不发送</span><br>                <span class="hljs-keyword">if</span> (session.equals(excludeSession)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (session.isOpen()) &#123;<br>                    session.sendMessage(textMessage);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将操作广播给该图片的所有用户</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pictureEditResponseMessage</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastToPicture</span><span class="hljs-params">(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        broadcastToPicture(pictureId, pictureEditResponseMessage, <span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>:star:配置类中涉及的拦截器<code>Interceptor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xin.xinpicturebackend.manager.websocket;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.util.ObjUtil;<br><span class="hljs-keyword">import</span> com.github.xiaoymin.knife4j.core.util.StrUtil;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.ErrorCode;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.exception.ThrowUtils;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.auth.SpaceUserAuthManager;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.manager.auth.model.SpaceUserPermissionConstant;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.Picture;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.Space;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.entity.User;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.model.enums.SpaceTypeEnum;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.PictureService;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.SpaceService;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.SpaceUserService;<br><span class="hljs-keyword">import</span> com.xin.xinpicturebackend.service.UserService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.http.server.ServerHttpRequest;<br><span class="hljs-keyword">import</span> org.springframework.http.server.ServerHttpResponse;<br><span class="hljs-keyword">import</span> org.springframework.http.server.ServletServerHttpRequest;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.WebSocketHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.server.HandshakeInterceptor;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Websocket 拦截器，在建立连接时进行校验</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WsHandshakeInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandshakeInterceptor</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PictureService pictureService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SpaceService spaceService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SpaceUserAuthManager spaceUserAuthManager;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">beforeHandshake</span><span class="hljs-params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取当前登陆用户</span><br>        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> ServletServerHttpRequest) &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> ((ServletServerHttpRequest) request).getServletRequest();<br>            <span class="hljs-comment">//从请求中获取参数</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;pictureId&quot;</span>);<br>            <span class="hljs-keyword">if</span> (StrUtil.isBlank(pictureId)) &#123;<br>                log.error(<span class="hljs-string">&quot;缺少图片参数，拒绝握手！&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-comment">//获取当前用户</span><br>            <span class="hljs-type">User</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> userService.getLoginUser(servletRequest);<br>            <span class="hljs-keyword">if</span> (ObjUtil.isEmpty(loginUser)) &#123;<br>                log.error(<span class="hljs-string">&quot;用户未登录，拒绝握手！&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-comment">//校验用户是否有编辑当前图片的权限</span><br>            <span class="hljs-type">Picture</span> <span class="hljs-variable">picture</span> <span class="hljs-operator">=</span> pictureService.getById(pictureId);<br>            <span class="hljs-keyword">if</span> (ObjUtil.isEmpty(picture)) &#123;<br>                log.error(<span class="hljs-string">&quot;图片不存在，拒绝握手！&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-comment">//校验空间</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">spaceId</span> <span class="hljs-operator">=</span> picture.getSpaceId();<br>            <span class="hljs-type">Space</span> <span class="hljs-variable">space</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (spaceId != <span class="hljs-number">0</span>) &#123;<br>                space = spaceService.getById(spaceId);<br>                <span class="hljs-keyword">if</span> (ObjUtil.isEmpty(space)) &#123;<br>                    log.error(<span class="hljs-string">&quot;空间不存在，拒绝握手！&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-comment">//空间存在，判断是否为团队空间</span><br>                <span class="hljs-keyword">if</span> (space.getSpaceType() != SpaceTypeEnum.TEAM.getValue()) &#123;<br>                    log.error(<span class="hljs-string">&quot;非团队空间，拒绝握手！&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//spaceId 为 0 ，则为公共空间</span><br>            List&lt;String&gt; permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);<br>            <span class="hljs-keyword">if</span> (!permissionList.contains(SpaceUserPermissionConstant.PICTURE_EDIT)) &#123;<br>                log.error(<span class="hljs-string">&quot;用户无权限编辑图片，拒绝握手！&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-comment">//所有校验通过，可以建立连接</span><br>            <span class="hljs-comment">//（1）设置用户登陆信息等属性到WebSocket会话中</span><br>            attributes.put(<span class="hljs-string">&quot;user&quot;</span>, loginUser);<br>            attributes.put(<span class="hljs-string">&quot;userId&quot;</span>, loginUser.getId());<br>            attributes.put(<span class="hljs-string">&quot;pictureId&quot;</span>, Long.valueOf(pictureId)); <span class="hljs-comment">//记得转化为 Long 类型</span><br><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHandshake</span><span class="hljs-params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception)</span> &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="2-Disruptor-优化"><a href="#2-Disruptor-优化" class="headerlink" title="2.Disruptor 优化"></a>2.Disruptor 优化</h2><h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p><code>WebSocket</code>通常是长连接，每个客户端都需要占用服务器资源。在 <code>Spring WebSocket</code> 中，每个 <code>WebSocket</code> 连接对应一个独立的 <code>WebSocketSession</code> 消息的处理是在该 <code>WebSocketSession</code> 所属线程中执行。虽然多个用户的消息处理是可以并发执行的，但是处理某条消息使用的 <strong>同一个线程</strong> 当某个用户发送大量消息时，线程会按照先后顺序同步执行，若是执行消息的耗时较长，会导致系统响应时间变长，设置会由于无法即时处理完消息而释放资源导致服务器资源耗尽。</p>
<h3 id="2-2-问题解决"><a href="#2-2-问题解决" class="headerlink" title="2.2 问题解决"></a>2.2 问题解决</h3><p>开设一个线程专门用来异步处理消息。但是还是要保证操作是按照顺序同步给其他客户端，因此需要引入一个队列。将任务按照顺序放到队列中，交给线程处理</p>
<p><img src="/staticImg/image-20250513234915125.png" alt="image-20250513234915125"></p>
<p>其实上述场景使用线程池即可实现，但由于是协同编辑场景，需要尽可能保证低延迟，因此选用一种高级技术 Disruptor 无锁队列来减少线程上下文切换，能够在高并发场景下保持低延迟和提高吞吐量，另外，其还有一个优点，可以将任务放到队列中，通过优雅停机机制，在服务停止之前执行完所有的任务，再退出服务，防止消息丢失。</p>
<h3 id="2-3-介绍"><a href="#2-3-介绍" class="headerlink" title="2.3 介绍"></a>2.3 介绍</h3><p>具体请看 <code>功能类框架</code> 中 的 <code>Disruptor</code> 介绍</p>
<h1 id="项目重构"><a href="#项目重构" class="headerlink" title="项目重构"></a>项目重构</h1><h2 id="1-DDD领域驱动设计"><a href="#1-DDD领域驱动设计" class="headerlink" title="1.DDD领域驱动设计"></a>1.<code>DDD</code>领域驱动设计</h2><h3 id="1-1-软件架构模式的演进"><a href="#1-1-软件架构模式的演进" class="headerlink" title="1.1 软件架构模式的演进"></a>1.1 软件架构模式的演进</h3><h4 id="1-1-1-传统单体架构"><a href="#1-1-1-传统单体架构" class="headerlink" title="1.1.1 传统单体架构"></a>1.1.1 传统单体架构</h4><p>所有的功能都集成在一个单一的应用程序中，所有模块和组件都在同一个进程内运行，请求直接操作数据库，不进行代码分层，易于开发和部署，尤其适合小型或简单的应用，但是随着业务增长和需求和变更，单体架构将变得难以扩展和维护，不同的功能耦合在一起，导致更新某个功能可能影响到整个系统</p>
<h4 id="1-1-2-分层架构"><a href="#1-1-2-分层架构" class="headerlink" title="1.1.2 分层架构"></a>1.1.2 分层架构</h4><p>应用被划分为不同的层（如业务接入层、业务逻辑层、数据访问层），每一层负责特定的功能，层与层之间通过接口进行交互，促进了模块化和职责分离，便于维护和管理</p>
<p>但是层与层之间的紧密耦合限制了灵活性，且随着系统复杂度的增加，可能导致性能下降和维护难度增加，并且可扩展性和弹性伸缩性差</p>
<h4 id="1-1-3-微服务架构"><a href="#1-1-3-微服务架构" class="headerlink" title="1.1.3 微服务架构"></a>1.1.3 微服务架构</h4><p>将系统拆分为多个小而独立的服务，每个服务负责处理一组特定的功能，每个服务通常由独立的团队开发、部署和维护、服务之间通过轻量级协议（如 HTTP、自定义协议或消息队列）进行通信</p>
<p>服务之间独立、易于扩展和维护。每个微服务都可以独立部署、开发和扩展，且易于使用不同的技术栈</p>
<h4 id="1-1-4SOA-架构"><a href="#1-1-4SOA-架构" class="headerlink" title="1.1.4SOA 架构"></a>1.1.4SOA 架构</h4><p>也是将系统拆分为多个独立的服务，但是其拆分粒度没有微服务架构细，且各个服务之间的通信通过<code>服务总线（bus）</code>进行通信</p>
<h3 id="1-2DDD-领域驱动设计概念"><a href="#1-2DDD-领域驱动设计概念" class="headerlink" title="1.2DDD 领域驱动设计概念"></a>1.2DDD 领域驱动设计概念</h3><p>其通过领域驱动设计方法定义领域模型，从而<strong>确定业务和应用的边界</strong>，保证业务模型和代码模型的一致性。</p>
<p>:star:DDD 是一种设计思想：<strong>确定业务和应用的边界</strong></p>
<p>:star:微服务架构：<strong>将系统拆分为多个小而独立的服务</strong></p>
<p>从上面两个方面可以看出：DDD 主要和微服务架构结合使用</p>
<p><strong>拆分服务也是一种艺术</strong>，DDD 可以成为微服务架构的前置操作，先利用 DDD 思想进行拆分，让系统更贴合业务，然后对将各个拆分出来的业务部署为单独的服务。</p>
<p>:star:总结：<strong>DDD 就是为了让系统更贴合业务，让大型系统更利于独立建设和维护</strong></p>
<p>DDD 的适用场景：</p>
<ol>
<li>业务复杂的系统：如金融系统、电商平台等，涉及的业务逻辑复杂且频繁变化</li>
<li>需要与多个部门和团队合作的项目，DDD 强调跨部门协作，适用于多方参与的大项目</li>
<li>长周期、长维护的项目：DDD 强调可维护性与演化，适合需要长期维护和扩展的系统</li>
</ol>
<h3 id="1-3DDD-名词解释"><a href="#1-3DDD-名词解释" class="headerlink" title="1.3DDD 名词解释"></a>1.3DDD 名词解释</h3><h4 id="1-3-1-领域"><a href="#1-3-1-领域" class="headerlink" title="1.3.1 领域"></a>1.3.1 领域</h4><p>领域就是用于确定范围的，而范围就是边界，一个领域又可以分为多个子域，子域根据重要程度和功能特性，可划分为：</p>
<ul>
<li>通用域：系统中一些通用、不特定于某一业务的领域，他们在多个不同领域和系统中都有应用</li>
<li>支撑域：指在系统中起到支持作用，但是并不是直接驱动业务价值的部分（例如网关）</li>
<li>核心域：指系统中最关键的部分，是业务的核心竞争力所在，能够为企业带来最大的价值</li>
</ul>
<p>不同的公司，对于这三类子域的划分是有区别的</p>
<h4 id="1-3-2-界限上下文"><a href="#1-3-2-界限上下文" class="headerlink" title="1.3.2 界限上下文"></a>1.3.2 界限上下文</h4><p>指一个明确的边界，规定了某个子领域的业务模型和语言，确保在该上下文的术语、规则、模型不与其他上下文冲突</p>
<p>例如在电商场景下，我们统一叫物品为商品，将用户购买商品的行为叫下单</p>
<h4 id="1-3-3-实体"><a href="#1-3-3-实体" class="headerlink" title="1.3.3 实体"></a>1.3.3 实体</h4><p>一般业务对象，且具有唯一标识对象都是实体。在代码中所谓的唯一标识就是 ID ，例如，订单有订单 ID ,用户有用户 ID，他们都是典型的实体</p>
<p>实体的关键点在于唯一标识，随着生命周期的变化，实体的属性可能会变化，例如订单可以从未完成变成已完成，但是其 ID 不会改变</p>
<p>实体映射到代码就是实体类，通常采用 <strong>充血模型</strong> 来实现，即与这个实体相关的所有业务逻辑都写在实体类中，如果需要跨过多个实体类才能完成的业务逻辑，会写在领域服务中。</p>
<h4 id="1-3-4-值对象"><a href="#1-3-4-值对象" class="headerlink" title="1.3.4 值对象"></a>1.3.4 值对象</h4><p>值对象没有唯一标识，创建后就不允许修改了，只能用另外一个值对象来进行 <strong>整体替换</strong>。通常用于描述对象的属性，用于对实体的状态和特征进行描述</p>
<p>非常典型的值对象就是地址。比如用户实体对象有地址这个属性，那么这个地址就是值对象，它没有唯一标识，且创建后就不允许修改其本身的值，如果用户需要修改地址，那么这个属性就是被整体替换的，拥有这样特性的对象，就是值对象</p>
<p>:bulb:实体和值对象并不是一成不变的，比如对电脑主机来说，显卡是一个值对象，显卡就换一个，而对显卡厂商来说，显卡是实体，他们有编号需要被追踪和管理的</p>
<h4 id="1-3-5-聚合"><a href="#1-3-5-聚合" class="headerlink" title="1.3.5 聚合"></a>1.3.5 聚合</h4><p>实体和值对象是基础的领域对象，聚合将多个实体和值对象组合成一个整体，实现高内聚低耦合</p>
<p>简单来说实体和值对象是个体，个体与个体之间的合作需要被“领导”，而聚合就是将他们组织起来协同工作，这样才能保证聚合内数据的一致性（组织统一口径）。它可作为微服务拆分的最小单位。</p>
<p>聚合还是数据修改和持久化得的基本单位，实现数据的持久化</p>
<h4 id="1-3-6-聚合根"><a href="#1-3-6-聚合根" class="headerlink" title="1.3.6 聚合根"></a>1.3.6 聚合根</h4><p>聚合根就好比聚合内的带头人，聚合内的多个实体不会直接对外提供接口访问，而是由聚合根统一提供对外接口。</p>
<p><strong>一个聚合内只有一个聚合根</strong>，聚合根通过对象引用的方式组织聚合内的实体和值对象，聚合根之间的合作是通过 ID 关联的</p>
<p>这里需要注意：聚合根也是一个实体，也具有业务属性和业务逻辑和唯一标识</p>
<p>例如订单域内只有订单和订单子项两个实体，那订单就是这个域中的聚合根</p>
<h4 id="1-3-7-领域服务"><a href="#1-3-7-领域服务" class="headerlink" title="1.3.7 领域服务"></a>1.3.7 领域服务</h4><p>聚合根可以实现跨多个实体的复杂业务行为，但是为了实现高内聚和低耦合，聚合根内部应该更聚焦与自身强关联的业务行为，复杂的跨多实体的业务可以放在领域服务中实现</p>
<p>领域服务是指那些 <strong>不能归属于某个单一实体或值对象，但又属于子领域模型的一部分</strong> 的业务逻辑。领域服务封装了对领域对象进行操作的核心业务规则，通常用于处理跨多个实体的操作，或者当业务逻辑无法直接归属于某个特定聚合时。</p>
<p>例如一个订单系统，需要处理订单支付功能时，而支付涉及订单、用户账户、支付信息等多个实体，这个支付操作不太好归属某个实体，这样的逻辑就可以放到领域服务中</p>
<h3 id="1-4DDD-的分层架构"><a href="#1-4DDD-的分层架构" class="headerlink" title="1.4DDD 的分层架构"></a>1.4DDD 的分层架构</h3><p>在领域驱动涉及中，分层架构是一种常见的设计模式，用于组织和管理系统的复杂性。通过将应用分为不同的层次，每一层都有清晰的责任和角色，从而促进了代码的高内聚、低耦合和可维护性。</p>
<p>DDD 的分层架构主要有四层：<strong>用户接口层</strong>、<strong>应用层</strong>、<strong>领域层</strong>、<strong>基础设施层</strong>。每层负责不同的职责。协调工作以实现系统的整体功能</p>
<p>除基础设施层外，严格来说每层只能与 <strong>直接下层</strong> 产生依赖，即领域层只能被应用层调用，应用层只能被用户接口层调用</p>
<p>当然也有 松散分层架构， 层与层之间的依赖和交互更加灵活，不严格分隔。适用于快速开发，但随着系统复杂度的增加，可能变得难以维护</p>
<h4 id="star-分层架构图"><a href="#star-分层架构图" class="headerlink" title=":star:分层架构图"></a>:star:分层架构图</h4><p><img src="/staticImg/image-20250523003125447.png" alt="image-20250523003125447"></p>
<h4 id="star-拆分逻辑图"><a href="#star-拆分逻辑图" class="headerlink" title=":star:拆分逻辑图"></a>:star:拆分逻辑图</h4><p><img src="/staticImg/image-20250523003253927.png" alt="image-20250523003253927"></p>
<h1 id="bulb-图库项目待完成的功能"><a href="#bulb-图库项目待完成的功能" class="headerlink" title=":bulb:图库项目待完成的功能"></a>:bulb:图库项目待完成的功能</h1><ul>
<li><input disabled="" type="checkbox"> 1.普通用户上传图片后需要审核，但是用户无法看到自己待审核的图片</li>
<li><input disabled="" type="checkbox"> 2.用户会员功能</li>
<li><input disabled="" type="checkbox"> 3.部署到服务器</li>
<li><input disabled="" type="checkbox"> 4.现在服务器内存不够：将服务器换成 linux 或者再租一个服务器</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.xintest.dpdns.org">xin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.xintest.dpdns.org/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/">https://blog.xintest.dpdns.org/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/encrypt/">encrypt</a><a class="post-meta__tags" href="/tags/%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/">开发流程</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/06/12/%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE-xin-valv/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2"></div></div><div class="info-2"><div class="info-item-1">xin-valv项目1.项目介绍（后续补上）xxx 2.项目初始化2.1环境配置后端-java（跟随项目补充） JDK：21 Spring Boot：3.3.1 Mybatis-plus：3.5.10.1 工具类 Hutool：5.8.26  前端-React（跟随项目补充）UI组件库 Ant-Design UI：文档地址 Material UI-v7.1.1：文档地址 shadcn UI：文档地址 Webbie UI：文档地址  工具库 React Player：文档地址，React Player是一个非常流行的 React 视频播放器组件，支持多种视频格式和流媒体协议。  使用，使用 npm 安装  1npm install react-player   在页面中使用（:point_right:注意（坑）：若是安装版本为V2.16.0，则文件地址使用url，若是V3.0.0则使用src  1234567891011import React from &#x27;react&#x27;import ReactPlayer from &#x27;react-player&#x27...</div></div></div></a><a class="pagination-related" href="/2025/01/11/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-%E5%90%84%E7%A7%8D%E5%8D%8F%E8%AE%AE/" title="科学上网-各种协议"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">科学上网-各种协议</div></div><div class="info-2"><div class="info-item-1">网络协议参考视频网址：不良林 1.ss（ShadowSocks）协议（1）加密方式：对称加密(对数据进行加密)（2）配置-服务端123456789&#123;    &quot;server&quot;: &quot;0.0.0.0&quot;,    &quot;mode&quot;: &quot;tcp_and_udp&quot;,    &quot;server_port&quot;: 8388,    &quot;local_port&quot;: 1080,    &quot;password&quot;: &quot;123456&quot;,    &quot;timeout&quot;: 86400,    &quot;method&quot;: &quot;chacha20-ietf-poly1305&quot;&#125;  加密方式可以自主选择，但是客户端和服务器要保持一致 （3）查看日志的命令（因为ss协议容易被精准识别）1journalctl -u shadowssocks-libev.service -f  通过日志可以观察到GFW对服务器进行的重放攻...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/03/java-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="java 学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">java 学习笔记</div></div><div class="info-2"><div class="info-item-1">NOW、待做1.给blog加上评论，需要完善…..2.普通用户，最开始注册的时候没有填写个人信息，导致home界面无法显示个人中心的数据 2.页面的鉴权功能（限制进入人员管理页面）（完成一半：非管理人员无法修改数据） 3.将CodePen中的钟表加在主页 4.对blog中简历界面，增加一个功能，通过在线填写数据，传给后端后返回一个pdf的简历 5.引入redis和Es 6.通过windows的定时任务，定时删除数据库中的oldFile（图片&#x2F;pdf）需求描述：在数据库中存储文件的表中加上一个字段 ‘status’ ，值为0或1，0代表该文件为oldFile,在定时任务中进行删除，否则不删除 7.完善一些细节，比如文件的逻辑删除，loading界面等等 一、git实现同时对接github和gitee？原文网址具体操作：  生成 key，将邮件地址替换为你 Gitee 或者 Github 使用的邮件地址 123#生成 key，将邮件地址替换为你 Gitee 或者 Github 使用的邮件地址#注意：在生成密钥时不要输入密码，直接回车即可，不然之后每次连都需要输入密码ssh-...</div></div></div></a><a class="pagination-related" href="/2025/01/03/Web%E5%AE%89%E5%85%A8-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Web安全 学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">Web安全 学习笔记</div></div><div class="info-2"><div class="info-item-1">WEB安全基础概述​	基础概述中涉及的工具的获取：  名词解释：121.https://www.cnblogs.com/sunny11/p/13583083.html2.封包和抓包的不同之处？  整体和零散的区别，封包能精确到每个操作的数据包  涉及的靶场：121.墨者靶场2.https://www.vulhub.org/		Vulhub靶场，常见中间件漏洞：自己搭建靶场  涉及的工具及网站（有一些可能有后门，尽量不要在真实机上使用）：12345678910111213141516171819201.Burpsuit  : 抓包工具2.宝塔		: 搭建网站的工具3.快代理		: 配置ip代理4.封包监听工具（傻瓜式）/WPE封包四件套	：能抓到完成某种操作的一系列数据包集合的工具；普通抓包工具抓到的都是集合中分散的数据包&#x27;&#x27;&#x27;端口扫描工具1.超级ping：CDN服务识别2.Masscan：端口扫描，应用协议3.Wafw00f（比较全）：Web应用防护防火墙识别4.Nmap：端口扫描，应用协议，防火墙识别5.lbd：负载均衡、广域网负载均衡、应用层负载...</div></div></div></a><a class="pagination-related" href="/2025/01/03/vue2-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="vue2 学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">vue2 学习笔记</div></div><div class="info-2"><div class="info-item-1">笔记脚手架文件结构├── node_modules  ├── public │   ├── favicon.ico: 页签图标 │   └── index.html: 主页面 ├── src │   ├── assets: 存放静态资源 │   │   └── logo.png │   │── component: 存放组件 │   │   └── HelloWorld.vue │   │── App.vue: 汇总所有组件 │   │── main.js: 入口文件 ├── .gitignore: git版本管制忽略的配置 ├── babel.config.js: babel的配置文件 ├── package.json: 应用包配置文件  ├── README.md: 应用描述文件 ├── package-lock.json：包版本控制文件  关于不同版本的Vue vue.js与vue.runtime.xxx.js的区别： vue.js是完整版的Vue，包含：核心功能 + 模板解析器。 vue.runtime.xxx.js是运行版的Vue，只包含：核心功能；没有模板解析器。  ...</div></div></div></a><a class="pagination-related" href="/2025/01/03/%E5%85%B6%E5%AE%83/" title="其它"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">其它</div></div><div class="info-2"><div class="info-item-1">一、win10修改SMB(共享文件)的默认端口 4451.步骤基于安全的考虑，服务器端的SMB(共享文件夹)应用通过FRP等工具将SMB应用的445端口映射到了公网IP的其他端口，或者直接修改了SMB的默认端口  win10 右键开始菜单 - Windows PowerShell(管理员)，以管理员模式打开PowerShell，输入以下命令配置一个端口转发： 1netsh interface portproxy add v4tov4 listenport=445 listenaddress=127.0.0.1 connectport=30455 connectaddress= 117.73.12.12  效果就是本机访问127.0.0.1的445端口时，会转发到远程IP地址(117.73.12.12)的30445端口  查看端口转发配置列表，可以看到已经成功转发 1netsh interface portproxy show all  打开系统服务管理器，找到server，右键属性–&gt; 启动类型改为禁用，然后重启电脑，再次查看服务状态，没有正在运行就是成功了 单击开始菜单，...</div></div></div></a><a class="pagination-related" href="/2025/01/11/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-%E5%90%84%E7%A7%8D%E5%8D%8F%E8%AE%AE/" title="科学上网-各种协议"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-11</div><div class="info-item-2">科学上网-各种协议</div></div><div class="info-2"><div class="info-item-1">网络协议参考视频网址：不良林 1.ss（ShadowSocks）协议（1）加密方式：对称加密(对数据进行加密)（2）配置-服务端123456789&#123;    &quot;server&quot;: &quot;0.0.0.0&quot;,    &quot;mode&quot;: &quot;tcp_and_udp&quot;,    &quot;server_port&quot;: 8388,    &quot;local_port&quot;: 1080,    &quot;password&quot;: &quot;123456&quot;,    &quot;timeout&quot;: 86400,    &quot;method&quot;: &quot;chacha20-ietf-poly1305&quot;&#125;  加密方式可以自主选择，但是客户端和服务器要保持一致 （3）查看日志的命令（因为ss协议容易被精准识别）1journalctl -u shadowssocks-libev.service -f  通过日志可以观察到GFW对服务器进行的重放攻...</div></div></div></a><a class="pagination-related" href="/2025/01/03/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="网络安全 学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">网络安全 学习笔记</div></div><div class="info-2"><div class="info-item-1">一、windows创建定时任务参考链接 1）通过图形化界面创建win + R 键 ： 输入： taskschd.msc   回车   -》 创建基本任务 -》 按向导操作即可 2）通过编写脚本创建1234567schtasks /create /tn &quot;DailyBackup&quot; /tr &quot;C:\backup.bat&quot; /sc daily /st 08:00//其中schtasks：用于创建定时任务/tn：参数指定任务名称/tr：参数指定要执行的脚本文件路径/sc：参数指定任务执行的频率/st：参数指定任务开始的时间  3）通过命令行对定时任务的一些操作12schtasks /query /tn &quot;DailyBackup&quot;    #查看任务信息schtasks /delete /tn &quot;DailyBackup&quot; /f #删除任务  二、linux进程被kill 后，查看原因1234dmesg | egrep -i -B100 &#x27;killed process&#x27; # 或者 egrep -...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">xin</div><div class="author-info-description">收藏从未停止，学习从未开始！</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">新项目开发流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-pom-xml"><span class="toc-number">1.2.</span> <span class="toc-text">导入依赖-pom.xml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-application-yml"><span class="toc-number">1.3.</span> <span class="toc-text">配置文件-application.yml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.4.</span> <span class="toc-text">启动类添加注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E7%B1%BB%E7%BC%96%E5%86%99"><span class="toc-number">1.5.</span> <span class="toc-text">通用类编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%82%E5%B8%B8%E5%8C%85-exception"><span class="toc-number">1.5.1.</span> <span class="toc-text">1.异常包-exception</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%9A%E7%94%A8%E5%8C%85-common"><span class="toc-number">1.5.2.</span> <span class="toc-text">2.通用包-common</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">前后端分离项目-跨域问题处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.6.1.</span> <span class="toc-text">解决方式：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%90%8E%E7%AB%AF%E5%A4%84%E7%90%86%EF%BC%8C%E6%94%AF%E6%8C%81%E8%B7%A8%E5%9F%9F"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">1）后端处理，支持跨域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%90%8E%E7%AB%AF%E4%B8%8D%E5%A4%84%E7%90%86-%E4%BB%A3%E7%90%86%EF%BC%88nginx%EF%BC%89"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">2）后端不处理-代理（nginx）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.</span> <span class="toc-text">运行后端项目-健康检查测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96-Vue"><span class="toc-number">1.8.</span> <span class="toc-text">前端初始化-Vue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85-nodeJs"><span class="toc-number">1.8.1.</span> <span class="toc-text">1.安装 nodeJs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96-Vue-%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.8.2.</span> <span class="toc-text">2.初始化 Vue 项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.8.3.</span> <span class="toc-text">3.安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85%E7%BB%84%E4%BB%B6%E5%BA%93-antd-vue"><span class="toc-number">1.8.4.</span> <span class="toc-text">4.安装组件库-antd-vue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%B3%A8%E5%86%8C%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">1.8.5.</span> <span class="toc-text">5.注册组件库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%AE%89%E8%A3%85%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E5%B7%A5%E5%85%B7-axios"><span class="toc-number">1.8.6.</span> <span class="toc-text">6.安装异步请求工具-axios</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%AE%89%E8%A3%85%E6%8E%A5%E5%8F%A3%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7-umijs-openapi"><span class="toc-number">1.8.7.</span> <span class="toc-text">7.安装接口生成工具-umijs&#x2F;openapi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87%E4%BB%A3%E7%90%86%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F-vite"><span class="toc-number">1.8.8.</span> <span class="toc-text">8.前端通过代理解决跨域-vite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-pinia-%E5%85%A8%E5%B1%80%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86-%E6%AF%94-vuex-%E6%9B%B4%E5%8A%A0%E5%A5%BD%E7%94%A8"><span class="toc-number">1.8.9.</span> <span class="toc-text">9.pinia 全局状态管理-比 vuex 更加好用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8A%9F%E8%83%BD%E8%A7%A3%E8%AF%BB"><span class="toc-number">2.</span> <span class="toc-text">开发过程的功能解读</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.</span> <span class="toc-text">用户的权限控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0-MybatisX"><span class="toc-number">2.2.</span> <span class="toc-text">通用增删改查方法的实现-MybatisX</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Idea-%E5%A5%BD%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">Idea 好用插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MybatisX"><span class="toc-number">3.1.</span> <span class="toc-text">1.MybatisX</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%893-5-9-%E7%89%88%E6%9C%AC%E5%8F%8A%E4%BB%A5%E4%B8%8A%E5%88%86%E9%A1%B5%E6%9C%89%E6%94%B9%E5%8F%98"><span class="toc-number">3.1.1.</span> <span class="toc-text">1）3.5.9 版本及以上分页有改变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E5%89%8D%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E7%B2%BE%E5%BA%A6%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%EF%BC%88%E5%89%8D%E7%AB%AF%E4%B8%A2%E5%A4%B1%E7%B2%BE%E5%BA%A6%EF%BC%89"><span class="toc-number">3.1.2.</span> <span class="toc-text">2）前后端数据精度不一致问题（前端丢失精度）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Generate-All-Getter-And-Setter"><span class="toc-number">3.2.</span> <span class="toc-text">2.Generate All Getter And Setter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%B7%A5%E5%85%B7%E5%BA%93"><span class="toc-number">4.</span> <span class="toc-text">前端工具库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%89%8D%E7%AB%AF%E4%B8%8B%E8%BD%BD%E5%BA%93-file-saver"><span class="toc-number">4.1.</span> <span class="toc-text">1.前端下载库-file-saver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.1.</span> <span class="toc-text">1）安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">4.1.2.</span> <span class="toc-text">2）示例代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%B7%A5%E5%85%B7%E5%BA%93"><span class="toc-number">5.</span> <span class="toc-text">后端工具库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-html-%E8%A7%A3%E6%9E%90%E5%BA%93%EF%BC%88java%EF%BC%89-jsoup-%E5%BA%93"><span class="toc-number">5.1.</span> <span class="toc-text">1.html 解析库（java）-jsoup 库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="toc-number">6.</span> <span class="toc-text">项目优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">6.1.</span> <span class="toc-text">1.查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BC%93%E5%AD%98-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.1.1.</span> <span class="toc-text">1.1 缓存-使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-Redis-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="toc-number">6.1.2.</span> <span class="toc-text">1.2 分布式缓存-Redis 分布式缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1-%E4%BB%A5%E4%BA%91%E5%9B%BE%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%BA%E4%BE%8B"><span class="toc-number">6.1.3.</span> <span class="toc-text">1.3 缓存设计-以云图库项目为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C-redis-%E7%BC%93%E5%AD%98"><span class="toc-number">6.1.4.</span> <span class="toc-text">1.4 实际操作-redis 缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98-Caffeine"><span class="toc-number">6.1.5.</span> <span class="toc-text">1.5 实际操作-本地缓存 Caffeine</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.1.5.1.</span> <span class="toc-text">1.5.1 缓存设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-%E5%BC%80%E5%8F%91-java"><span class="toc-number">6.1.5.2.</span> <span class="toc-text">1.5.2 开发-java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">6.2.</span> <span class="toc-text">1.6 多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-1-%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-Caffeine-Redis"><span class="toc-number">6.2.1.</span> <span class="toc-text">1.6.1 实际操作-多级缓存-Caffeine + Redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star-%E6%89%A9%E5%B1%95"><span class="toc-number">6.3.</span> <span class="toc-text">:star:扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%BC%98%E5%8C%96-%E4%BB%A5%E4%BA%91%E5%9B%BE%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%BA%E4%BE%8B"><span class="toc-number">6.4.</span> <span class="toc-text">2.文件上传优化-以云图库项目为例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%BC%98%E5%8C%96"><span class="toc-number">6.4.1.</span> <span class="toc-text">2.1 图片上传优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%89%A9%E5%B1%95"><span class="toc-number">6.4.2.</span> <span class="toc-text">2.2 扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-%E6%96%87%E4%BB%B6%E7%A7%92%E4%BC%A0"><span class="toc-number">6.4.2.1.</span> <span class="toc-text">2.2.1 扩展知识-文件秒传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E5%92%8C%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-number">6.4.2.2.</span> <span class="toc-text">2.2.2 扩展知识-分片上传和断点续传</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96"><span class="toc-number">6.5.</span> <span class="toc-text">3.加载优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%BC%A9%E7%95%A5%E5%9B%BE"><span class="toc-number">6.5.1.</span> <span class="toc-text">3.1 缩略图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%87%92%E5%8A%A0%E8%BD%BD-%E4%B8%BB%E8%A6%81%E9%92%88%E5%AF%B9%E5%89%8D%E7%AB%AF"><span class="toc-number">6.5.2.</span> <span class="toc-text">3.2 懒加载-主要针对前端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#star-%E6%89%A9%E5%B1%95-%E6%B8%90%E8%BF%9B%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-number">6.5.3.</span> <span class="toc-text">:star:扩展-渐进式加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3CDN-%E5%8A%A0%E9%80%9F"><span class="toc-number">6.5.4.</span> <span class="toc-text">3.3CDN 加速</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">6.5.5.</span> <span class="toc-text">3.4 浏览器缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96"><span class="toc-number">6.6.</span> <span class="toc-text">4.文件存储优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-tips"><span class="toc-number">6.7.</span> <span class="toc-text">5.tips</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E7%B1%BB%E6%A1%86%E6%9E%B6"><span class="toc-number">7.</span> <span class="toc-text">功能类框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%E6%A1%86%E6%9E%B6-Sa-Token"><span class="toc-number">7.1.</span> <span class="toc-text">1.权限校验框架-Sa-Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.1 官方文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">7.1.2.</span> <span class="toc-text">1.2 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.3.</span> <span class="toc-text">1.3 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%95%B4%E5%90%88-Redis-%E5%8F%8A%E5%B0%86%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E5%BC%8F%E8%BD%AC%E6%88%90-jackson"><span class="toc-number">7.1.4.</span> <span class="toc-text">1.4 整合 Redis 及将序列化方式转成 jackson</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E5%A4%9A%E8%B4%A6%E5%8F%B7%E8%AE%A4%E8%AF%81%E4%BD%93%E7%B3%BB"><span class="toc-number">7.1.5.</span> <span class="toc-text">1.5 多账号认证体系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Kit-%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.1.5.1.</span> <span class="toc-text">（1）Kit 模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E9%80%BB%E8%BE%91"><span class="toc-number">7.1.6.</span> <span class="toc-text">1.6 权限认证逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E5%9B%BE%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Sa-Token"><span class="toc-number">7.1.7.</span> <span class="toc-text">1.7 图库项目中使用 Sa-Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E5%9D%91-request-%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93-body-%E6%98%AF%E4%B8%80%E4%B8%AA%E6%B5%81%EF%BC%8C%E5%8F%AA%E5%85%81%E8%AE%B8%E8%AF%BB%E4%B8%80%E6%AC%A1"><span class="toc-number">7.1.7.1.</span> <span class="toc-text">1.7.1 使用过程中的坑-request 的请求体(body)是一个流，只允许读一次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-2-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95"><span class="toc-number">7.1.7.2.</span> <span class="toc-text">1.7.2 踩坑记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%A1%86%E6%9E%B6-Apache-ShardingSphere"><span class="toc-number">7.2.</span> <span class="toc-text">2.分库分表框架-Apache ShardingSphere</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%A6%82%E5%BF%B5"><span class="toc-number">7.2.1.</span> <span class="toc-text">2.1 分库分表概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">7.2.2.</span> <span class="toc-text">2.2 官方文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">7.2.3.</span> <span class="toc-text">2.3 主要功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">7.2.4.</span> <span class="toc-text">2.4 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E9%9D%99%E6%80%81%E5%88%86%E8%A1%A8%E5%92%8C%E5%8A%A8%E6%80%81%E5%88%86%E8%A1%A8"><span class="toc-number">7.2.5.</span> <span class="toc-text">2.5 静态分表和动态分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.6.</span> <span class="toc-text">2.6 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">7.2.7.</span> <span class="toc-text">2.7 注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%AB%98%E6%80%A7%E8%83%BD%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6%EF%BC%88%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97%EF%BC%89-Disruptor"><span class="toc-number">7.3.</span> <span class="toc-text">3.高性能并发框架（无锁队列）-Disruptor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.3.1.</span> <span class="toc-text">3.1 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">7.3.2.</span> <span class="toc-text">3.2 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">7.3.3.</span> <span class="toc-text">3.3 配置类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E5%B0%8F%E7%9F%A5%E8%AF%86%EF%BC%88%E5%8A%9F%E8%83%BD%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">拓展小知识（功能）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-WebSocket"><span class="toc-number">8.1.</span> <span class="toc-text">1.WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1SpringBoot-%E4%B8%AD%E9%9B%86%E6%88%90%E5%8E%9F%E7%94%9F-WebSocket-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">8.1.1.</span> <span class="toc-text">1.1SpringBoot 中集成原生 WebSocket-引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">8.1.2.</span> <span class="toc-text">1.2 配置类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Disruptor-%E4%BC%98%E5%8C%96"><span class="toc-number">8.2.</span> <span class="toc-text">2.Disruptor 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1 问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2 问题解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3 介绍</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%87%8D%E6%9E%84"><span class="toc-number">9.</span> <span class="toc-text">项目重构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-DDD%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">9.1.</span> <span class="toc-text">1.DDD领域驱动设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%BC%94%E8%BF%9B"><span class="toc-number">9.1.1.</span> <span class="toc-text">1.1 软件架构模式的演进</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E4%BC%A0%E7%BB%9F%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.1.1.</span> <span class="toc-text">1.1.1 传统单体架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.1.2.</span> <span class="toc-text">1.1.2 分层架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.1.3.</span> <span class="toc-text">1.1.3 微服务架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-4SOA-%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.1.4.</span> <span class="toc-text">1.1.4SOA 架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2DDD-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E6%A6%82%E5%BF%B5"><span class="toc-number">9.1.2.</span> <span class="toc-text">1.2DDD 领域驱动设计概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3DDD-%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">9.1.3.</span> <span class="toc-text">1.3DDD 名词解释</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-%E9%A2%86%E5%9F%9F"><span class="toc-number">9.1.3.1.</span> <span class="toc-text">1.3.1 领域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E7%95%8C%E9%99%90%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">9.1.3.2.</span> <span class="toc-text">1.3.2 界限上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E5%AE%9E%E4%BD%93"><span class="toc-number">9.1.3.3.</span> <span class="toc-text">1.3.3 实体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-%E5%80%BC%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.1.3.4.</span> <span class="toc-text">1.3.4 值对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-5-%E8%81%9A%E5%90%88"><span class="toc-number">9.1.3.5.</span> <span class="toc-text">1.3.5 聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-6-%E8%81%9A%E5%90%88%E6%A0%B9"><span class="toc-number">9.1.3.6.</span> <span class="toc-text">1.3.6 聚合根</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-7-%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.1.3.7.</span> <span class="toc-text">1.3.7 领域服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4DDD-%E7%9A%84%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.4.</span> <span class="toc-text">1.4DDD 的分层架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#star-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">9.1.4.1.</span> <span class="toc-text">:star:分层架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#star-%E6%8B%86%E5%88%86%E9%80%BB%E8%BE%91%E5%9B%BE"><span class="toc-number">9.1.4.2.</span> <span class="toc-text">:star:拆分逻辑图</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bulb-%E5%9B%BE%E5%BA%93%E9%A1%B9%E7%9B%AE%E5%BE%85%E5%AE%8C%E6%88%90%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">10.</span> <span class="toc-text">:bulb:图库项目待完成的功能</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/12/%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE-xin-valv/" title="Untitled">Untitled</a><time datetime="2025-06-12T15:01:17.015Z" title="Created 2025-06-12 23:01:17">2025-06-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%EF%BC%88Vue3+SpringBoot2%EF%BC%89/" title="新项目开发流程">新项目开发流程</a><time datetime="2025-05-25T14:55:07.556Z" title="Created 2025-05-25 22:55:07">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/11/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-%E5%90%84%E7%A7%8D%E5%8D%8F%E8%AE%AE/" title="科学上网-各种协议">科学上网-各种协议</a><time datetime="2025-01-11T08:09:03.000Z" title="Created 2025-01-11 16:09:03">2025-01-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/03/%E4%B8%AA%E4%BA%BA%E7%AE%80%E4%BB%8B/" title="个人简介">个人简介</a><time datetime="2025-01-03T13:31:52.000Z" title="Created 2025-01-03 21:31:52">2025-01-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/03/%E5%85%B6%E5%AE%83/" title="其它">其它</a><time datetime="2025-01-03T01:58:56.000Z" title="Created 2025-01-03 09:58:56">2025-01-03</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By xin</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>